{"id":"gmail-1","title":"Gmail Extension Quality Improvements","description":"## Context\n\nCode review of the openclaw-gmail extension identified several quality issues affecting the email experience. The extension uses `gog` (a Gmail CLI wrapper) for all Gmail API operations and integrates with OpenClaw's channel plugin system.\n\nKey problems:\n1. **Reply fragmentation**: Agent responses can be split across multiple emails due to block streaming being enabled when global agent defaults set `blockStreamingDefault: \"on\"`. Email should always batch the full response.\n2. **Unnatural quoting**: Quoted replies look robotic — no `<blockquote>` HTML styling, no `>` prefix in plain text, quotes go through markdown parsing which mangles them.\n3. **Missing configurability**: Auto-archive on reply is hardcoded with no way to disable.\n4. **gog coupling**: All Gmail operations spawn child processes via `gog` CLI. Long-term, a library/SDK approach would be cleaner.\n\n## Architecture\n\n- **Extension entry**: `index.ts` → registers `gmailPlugin` via `api.registerChannel()`\n- **Core files**: `channel.ts` (plugin def + gateway), `outbound.ts` (reply sending), `quoting.ts` (thread quote building), `inbound.ts` (email parsing), `monitor.ts` (polling), `sanitize.ts` (inbound HTML-to-plain-text conversion for LLM consumption)\n- **Dispatch**: Uses `runtime.channel.reply.dispatchReplyWithBufferedBlockDispatcher()` at `channel.ts:132`\n- **Outbound flow**: `sendGmailText()` in `outbound.ts` builds body, optionally appends quotes, converts to HTML via `marked` + `sanitize-html` npm package (inline at outbound.ts:147-153), sends via `gog gmail send`\n- **Quoting flow**: `fetchQuotedContext()` in `quoting.ts` fetches thread via `gog gmail thread get`, extracts last non-self message, formats as `On <date>, <sender> wrote:\\n\\n<body>`\n\n## Key Files\n\n- `src/channel.ts` — Plugin definition, capabilities, gateway, dispatch (365 lines)\n- `src/outbound.ts` — Reply composition and sending (176 lines)\n- `src/quoting.ts` — Thread quote building (231 lines)\n- `src/sanitize.ts` — Inbound HTML-to-plain-text conversion (strips tracking pixels, footers, signatures) (166 lines)\n- `src/outbound-check.ts` — Thread recipient validation (234 lines)\n- `src/monitor.ts` — Polling-based email sync (473 lines)\n- `src/config.ts` — Zod schemas for GmailConfig and GmailAccountSchema (33 lines)\n\n## OpenClaw Core Integration Points\n\n- Block streaming controlled by `replyOptions.disableBlockStreaming` passed to dispatcher\n- `textChunkLimit: 8000` set on plugin outbound config (`channel.ts:228`)\n- Agent prompt hints at `channel.ts:277-294` guide LLM behavior for email context\n- Core default chunk limit is 4000 chars; plugin's 8000 may not propagate to block streaming resolution for extension channels\n\n## Config Key Convention\n\nOpenClaw channels use the plugin ID as the config key under `cfg.channels`. The convention is `cfg.channels?.gmail`. Note: there is a pre-existing inconsistency in the codebase where `outbound.ts:49` reads config as `cfg.channels?.gmail` but `channel.ts:214` writes with `sectionKey: \"openclaw-gmail\"`. Follow the existing read pattern (`cfg.channels?.gmail`) for new config access.\n\n## Build & Test\n\n- No build script — the project is loaded as raw `.ts` by the OpenClaw runtime via a loader (Jiti)\n- `package.json` `main` field is `index.ts` (not compiled JS)\n- `peerDependencies` requires `openclaw >= 2026.1.0`\n- Test files exist: `src/sanitize.test.ts`, `src/outbound-check.test.ts` (run via the OpenClaw test harness or directly with a compatible test runner)\n- No standalone `npm test` script — verify changes by inspecting TypeScript types and running tests via the host project\n\n## Recommended Execution Order\n\n1. **gmail-1.1** (block streaming) — isolated to `channel.ts`, no overlap\n2. **gmail-1.3** (auto-archive config) — small, surgical change in `outbound.ts`\n3. **gmail-1.2** (quoting overhaul) — large restructure of `outbound.ts` and `quoting.ts`, do last to avoid line-number drift","status":"open","priority":1,"issue_type":"epic","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T12:29:32.106228777+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T12:39:25.007203682+13:00"}
{"id":"gmail-1.1","title":"Disable block streaming for email delivery","description":"## Problem\n\nWhen a user's OpenClaw config has `agents.defaults.blockStreamingDefault: \"on\"` (common for chat channels), Gmail sessions also stream block replies. Each flushed block triggers a separate `deliver()` call, which sends a **separate email**. This causes agent responses to be fragmented across multiple emails.\n\nThe block streaming coalescer has a 1-second idle timeout — if the agent pauses for >1s during generation (thinking, tool calls), the buffer flushes and sends what it has as a separate email.\n\n## Root Cause\n\n`channel.ts:132-142` calls `dispatchReplyWithBufferedBlockDispatcher` without passing `replyOptions.disableBlockStreaming`. Block streaming resolution in OpenClaw core (`get-reply-directives.ts:358-372`) checks:\n1. `opts.disableBlockStreaming` (not set by gmail)\n2. `agentCfg.blockStreamingDefault` (user's global setting)\n3. Falls back to \"off\"\n\nIf the user has streaming enabled globally, gmail inherits it.\n\n## Fix\n\nIn `src/channel.ts`, the dispatcher call at lines 132-142 currently looks like:\n\n```typescript\nawait runtime.channel.reply.dispatchReplyWithBufferedBlockDispatcher({\n  ctx: ctxPayload,\n  cfg,\n  dispatcherOptions: {\n    deliver,\n    humanDelay,\n    onError: (err: unknown, info: { kind: string }) => {\n      log?.error(`[gmail][${requestId}] ${info.kind} reply failed: ${String(err)}`);\n    },\n  },\n});\n```\n\nAdd `replyOptions` as a **sibling key** to `ctx`, `cfg`, and `dispatcherOptions` in the same object:\n\n```typescript\nawait runtime.channel.reply.dispatchReplyWithBufferedBlockDispatcher({\n  ctx: ctxPayload,\n  cfg,\n  dispatcherOptions: {\n    deliver,\n    humanDelay,\n    onError: (err: unknown, info: { kind: string }) => {\n      log?.error(`[gmail][${requestId}] ${info.kind} reply failed: ${String(err)}`);\n    },\n  },\n  replyOptions: {\n    disableBlockStreaming:\n      typeof gmailCfg?.blockStreaming === \"boolean\"\n        ? !gmailCfg.blockStreaming\n        : true,  // Default: disabled for email\n  },\n});\n```\n\nNote: `gmailCfg` is not currently available in the `dispatchGmailMessage` function scope. You need to resolve it from `cfg` the same way `outbound.ts:49` does:\n\n```typescript\nconst gmailCfg = cfg.channels?.gmail as GmailConfig | undefined;\n```\n\nImport `GmailConfig` from `./config.js` (already exported from that module).\n\n### Config schema updates\n\nAdd `blockStreaming` to the Zod schema in `src/config.ts` (`GmailConfigSchema` or top-level channel config) as an optional boolean.\n\nAlso add it to the JSON schema in `channel.ts` under `configSchema.schema.properties`:\n\n```typescript\nblockStreaming: { type: \"boolean\", default: false },\n```\n\n### Config key note\n\nThe extension reads config from `cfg.channels?.gmail` (see `outbound.ts:49`). Use this same path for the `blockStreaming` config. There is a pre-existing inconsistency where `channel.ts:214` writes with `sectionKey: \"openclaw-gmail\"` — do not change that; just follow the existing read pattern.\n\nThis approach follows the WhatsApp pattern in OpenClaw core (`web/auto-reply/monitor/process-message.ts:416-422`).\n\n## Testing\n\n1. Set `agents.defaults.blockStreamingDefault: \"on\"` in OpenClaw config\n2. Send an email that triggers a long agent response (e.g., ask for a detailed explanation)\n3. Verify the response arrives as a single email, not multiple\n4. Set `channels.gmail.blockStreaming: true` in config and verify streaming is re-enabled\n5. Remove both settings and verify default behavior (no streaming)\n\n## Acceptance Criteria\n\n- [ ] Gmail replies always arrive as a single email by default\n- [ ] `channels.gmail.blockStreaming` config option respected (boolean, default false)\n- [ ] No change to behavior when block streaming is globally off (already works correctly)\n- [ ] `blockStreaming` added to Zod schema in `config.ts` and JSON schema in `channel.ts`\n","status":"open","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T12:29:50.680569023+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T12:41:10.640096693+13:00","labels":["outbound","block-streaming","P0"],"dependencies":[{"issue_id":"gmail-1.1","depends_on_id":"gmail-1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-1.2","title":"Implement native Gmail-style HTML blockquote quoting","description":"## Problem\n\nQuoted replies in agent emails look robotic and unnatural compared to native Gmail quoting. Two issues:\n\n1. **No visual quote styling**: Quotes are plain text appended to the reply body with just a `On <date>, <sender> wrote:` header. No `<blockquote>` HTML, no border-left styling, no `gmail_quote` CSS class. Recipients see the quoted text as indistinguishable from the reply itself.\n\n2. **Quotes go through markdown parsing**: In `outbound.ts:135`, the quote is concatenated to the reply text BEFORE `marked.parse()` runs at line 146. This means the quoted email content gets markdown-interpreted — `*asterisks*` become italic, `#` becomes headings, URLs get auto-linked differently, etc.\n\n### Current flow (outbound.ts:80-159)\n\n```\nreply text + \"\\n\\n\" + quoted text  ->  marked.parse()  ->  sanitize-html  ->  gog send --body-html\n```\n\n### Desired flow\n\n```\nreply text  ->  marked.parse()  ->  sanitize-html  ->  append Gmail-style <blockquote> HTML  ->  gog send --body-html\n```\n\n## Fix\n\n### A. Restructure outbound.ts\n\nSeparate reply body processing from quote construction. The key change is in the `sendGmailText()` function:\n\n1. Parse **only the reply text** through `marked` + `sanitize-html` to get reply HTML (currently at lines 144-159)\n2. Build quote HTML separately using proper Gmail structure:\n   ```html\n   <div class=\"gmail_quote\">\n     <div dir=\"ltr\" class=\"gmail_attr\">On Mon, Feb 22, 2026 at 2:15 PM, John Doe wrote:</div>\n     <blockquote class=\"gmail_quote\" style=\"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex\">\n       [original message HTML, sanitized]\n     </blockquote>\n   </div>\n   ```\n3. Concatenate: `replyHtml + quoteHtml` for `--body-html`\n4. For `--body` (plain text): `reply text + \"\\n\\n\" + \"On <date>, <sender> wrote:\\n\" + \"> \" prefixed quote lines`\n\nCurrently the quote text and reply text are concatenated at line 135 (`body = \\`${text}\\n\\n${quotedContext}\\``), then the combined string goes through `marked.parse()` at line 146. The restructured flow should NOT concatenate them before markdown parsing.\n\n### B. Update quoting.ts — return structured data\n\n`fetchQuotedContext()` (lines 219-230) currently returns a pre-formatted string. Change it to return structured data so `outbound.ts` can build HTML and plain text separately:\n\n```typescript\nexport interface QuotedContent {\n  header: string;        // \"On Mon, Feb 22, 2026 at 2:15 PM, John Doe wrote:\"\n  bodyHtml: string;      // Sanitized HTML from original message\n  bodyPlain: string;     // Plain text from original message\n}\n```\n\n**There is exactly one call site** for `fetchQuotedContext`: `outbound.ts:129-136`. Update it to consume the new `QuotedContent` return type.\n\n### C. Update quoting.ts — extract HTML body\n\nThe current `extractBody()` function (lines 55-68) only extracts `text/plain` MIME parts. Add a new `extractHtmlBody()` that extracts the `text/html` MIME part for richer quotes:\n\n```typescript\nfunction extractHtmlBody(msg: GogRawMessage): string {\n  if (msg.payload.parts) {\n    const htmlPart = msg.payload.parts.find((p) => p.mimeType === \"text/html\");\n    if (htmlPart?.body?.data) {\n      return Buffer.from(htmlPart.body.data, \"base64\").toString(\"utf-8\");\n    }\n  }\n  if (msg.payload.body?.data) {\n    return Buffer.from(msg.payload.body.data, \"base64\").toString(\"utf-8\");\n  }\n  return \"\";\n}\n```\n\n### D. Sanitize HTML quotes before embedding\n\nThe HTML from the original message needs sanitization before embedding in the blockquote (strip scripts, tracking pixels, event handlers). Use the `sanitize-html` npm package (already a dependency — see `outbound.ts:3`) with permissive tag settings to preserve formatting (bold, links, lists, etc.) while removing dangerous content.\n\nNote: `src/sanitize.ts` is an **inbound** HTML-to-plain-text converter (for LLM consumption). It is NOT for HTML sanitization. Do not modify it for this task. Use the `sanitize-html` npm package directly for quote HTML sanitization.\n\n### E. Update quoteBody() for plain text\n\nThe `quoteBody()` function at `quoting.ts:181-183` is currently a no-op passthrough:\n```typescript\nfunction quoteBody(body: string): string {\n  return body;\n}\n```\n\nUpdate it to add `> ` prefix to each line for proper plain text quoting.\n\n## Files to modify\n\n- `src/quoting.ts` — Return structured `QuotedContent`, add `extractHtmlBody()`, fix `quoteBody()` for plain text\n- `src/outbound.ts` — Restructure to build HTML and plain text separately, append blockquote HTML after markdown parsing\n\n## Build & Test\n\nThis project has no standalone build script — it is loaded as raw `.ts` by the OpenClaw runtime via Jiti. There is no `npm test` command. Verify changes by:\n- Checking TypeScript types are correct (no compile errors)\n- Manually testing by sending an email reply through the OpenClaw runtime\n- Visually confirming the quote renders with Gmail-native blockquote styling in a real email client\n\n## Acceptance Criteria\n\n- [ ] Quoted replies render with Gmail-native `<blockquote>` styling (border-left, indentation)\n- [ ] Original message formatting (bold, links, lists) preserved in HTML quotes\n- [ ] Plain text `--body` uses `> ` prefix quoting\n- [ ] Quote text is NOT processed through markdown parser\n- [ ] Existing `includeQuotedReplies` config toggle (outbound.ts:67-69) still works\n- [ ] Single call site at `outbound.ts:129` updated to handle new `QuotedContent` return type\n- [ ] Visual verification: send a test reply and confirm quote looks native in Gmail/Outlook (manual test)\n","status":"open","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T12:30:15.875489376+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T12:41:12.437666474+13:00","labels":["quoting","outbound","P0"],"dependencies":[{"issue_id":"gmail-1.2","depends_on_id":"gmail-1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-1.3","title":"Make auto-archive on reply configurable","description":"## Problem\n\nIn `outbound.ts:163-173`, every thread reply automatically removes the `INBOX` label (archives the thread). This is hardcoded with no way to disable it.\n\n```typescript\nif (isThread) {\n  const archiveArgs = [\"gmail\", \"labels\", \"modify\", toValue];\n  if (account.email) archiveArgs.push(\"--account\", account.email);\n  archiveArgs.push(\"--remove\", \"INBOX\");\n  spawnGog(archiveArgs).catch((err) => {\n    console.error(`Failed to archive thread ${toValue}: ${err.message}`);\n  });\n}\n```\n\nSome users may want threads to remain in their inbox after the agent replies, especially for oversight/review workflows.\n\n## Fix\n\n### 1. Add config resolution in `outbound.ts`\n\nUse the existing `gmailCfg` (line 49) and `accountCfg` (line 66) variables already in scope within `sendGmailText()`:\n\n```typescript\n// These already exist in sendGmailText():\n// outbound.ts:49 -> const gmailCfg = cfg.channels?.gmail as GmailConfig | undefined;\n// outbound.ts:66 -> const accountCfg = gmailCfg?.accounts?.[accountId || \"default\"];\n\n// Add after the existing config resolution block (~line 78):\nconst archiveOnReply = accountCfg?.archiveOnReply\n  ?? gmailCfg?.defaults?.archiveOnReply\n  ?? true;\n```\n\nThen wrap the archive block at lines 163-173:\n\n```typescript\nif (isThread && archiveOnReply) {\n  // ... existing archive logic unchanged\n}\n```\n\n### 2. Update Zod schema in `src/config.ts`\n\nAdd `archiveOnReply` as an optional boolean to:\n- The account schema (per-account override)\n- The defaults schema (global default)\n\n### 3. Update JSON schema in `src/channel.ts`\n\nAdd to `configSchema.schema.properties.accounts.additionalProperties.properties`:\n```typescript\narchiveOnReply: { type: \"boolean\", default: true },\n```\n\nAnd to `configSchema.schema.properties.defaults.properties`:\n```typescript\narchiveOnReply: { type: \"boolean\", default: true },\n```\n\n## Config key note\n\nConfig is read from `cfg.channels?.gmail` (see `outbound.ts:49`). Follow this existing pattern. There is a pre-existing inconsistency where `channel.ts:214` writes with `sectionKey: \"openclaw-gmail\"` — do not change that.\n\n## Files to modify\n\n- `src/outbound.ts` — Add config check before archive (use existing `gmailCfg` at line 49 and `accountCfg` at line 66)\n- `src/config.ts` — Add `archiveOnReply` to Zod schema\n- `src/channel.ts` — Add `archiveOnReply` to JSON configSchema\n\n## Acceptance Criteria\n\n- [ ] `archiveOnReply: false` in account or defaults config prevents archiving\n- [ ] Default behavior unchanged (archives on reply when not configured)\n- [ ] Config resolution follows existing pattern: account -> defaults -> true\n- [ ] Both Zod schema (`config.ts`) and JSON schema (`channel.ts`) updated\n","status":"open","priority":2,"issue_type":"feature","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T12:30:30.217843004+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T12:41:13.966995139+13:00","labels":["outbound","config","P1"],"dependencies":[{"issue_id":"gmail-1.3","depends_on_id":"gmail-1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-1.4","title":"Evaluate migrating from gog CLI to googleapis library","description":"## Context\n\nAll Gmail API operations in the extension spawn `gog` (a Go CLI tool by steipete/gogcli) as child processes. This works but has overhead: ~50-200ms per-call (process spawn + Go binary startup), string-based error handling, no connection reuse, and fragile child process lifecycle management.\n\n## Research Findings\n\n### gog\n\n- Go CLI tool at `/home/jakemc/bin/gog` (v0.9.0), installed via Homebrew\n- **No library/SDK mode** — CLI-only, no importable Go library or Node.js SDK\n- Active maintenance (GitHub: steipete/gogcli, 78 open issues)\n- OAuth tokens stored in encrypted JWE keyring at `~/.config/gogcli/keyring/`\n- OAuth client_id/client_secret stored in plaintext at `~/.config/gogcli/credentials.json`\n- 15+ spawn calls across the extension codebase for different operations\n\n### googleapis (official Google API client for Node.js)\n\n- npm package `googleapis` — millions of weekly downloads, Google-maintained\n- Full TypeScript types, 1:1 mapping to Gmail REST API\n- Auth via `google-auth-library` with automatic token refresh\n- **Can reuse gog's existing OAuth client_id/client_secret** from `credentials.json`\n- Would need a one-time re-authorization to get a new refresh_token (same GCP project, same consent screen)\n- In-process calls, HTTP/2 keep-alive, typed exceptions, proper async\n\n### Comparison\n\n| Metric | gog CLI | googleapis |\n|--------|---------|------------|\n| Per-call overhead | ~50-200ms | ~0ms |\n| Error handling | Parse stderr | Typed exceptions |\n| Connection reuse | None | HTTP/2 keep-alive |\n| MIME construction | Handled by gog | Manual (use mailcomposer/nodemailer builder) |\n| Watch/push server | Built-in `gog gmail watch serve` | Need own HTTP endpoint (gateway already exists) |\n| Auth flow | `gog auth add` | Implement OAuth flow or extract existing token |\n\n### Migration Phases\n\n1. **Phase 1 (low effort)**: Replace simple spawn calls in extension (send, thread get, search, labels). ~2-4 hours per command.\n2. **Phase 2 (medium effort)**: Replace `gog gmail watch serve` with direct `googleapis` + gateway HTTP endpoint. ~1-2 days. Eliminates fragile child process lifecycle management.\n3. **Phase 3 (auth)**: Reuse existing client_id/secret, implement one-time OAuth flow for new refresh_token, store in OpenClaw config. ~2-4 hours.\n\n### Key Risk\n\nMIME message construction for send/reply is non-trivial. gog handles RFC 2822 formatting internally. With googleapis, need to construct MIME messages ourselves (libraries like `mailcomposer` help but add complexity).\n\n### Impact on Users\n\n- **If gog stays**: Users keep existing auth setup, no migration needed\n- **If googleapis replaces gog**: Users need a one-time re-authorization (browser popup, same GCP project). The painful OAuth app setup (GCP project, consent screen, scopes) is NOT repeated — only the token exchange.\n\n## Decision Needed\n\nWhether to migrate and on what timeline. Current recommendation: keep gog for now, track googleapis migration as a future improvement. The extension's current issues (block streaming, quoting) are independent of the transport layer.\n\n## Status\n\nResearch complete. No action required until a decision is made.","status":"open","priority":3,"issue_type":"decision","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T12:32:47.226802977+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T12:32:47.226802977+13:00","labels":["gog","architecture","research"],"dependencies":[{"issue_id":"gmail-1.4","depends_on_id":"gmail-1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
