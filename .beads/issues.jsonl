{"id":"gmail-1","title":"Gmail Extension Quality Improvements","description":"## Context\n\nCode review of the openclaw-gmail extension identified several quality issues affecting the email experience. The extension uses `gog` (a Gmail CLI wrapper) for all Gmail API operations and integrates with OpenClaw's channel plugin system.\n\nKey problems:\n1. **Reply fragmentation**: Agent responses can be split across multiple emails due to block streaming being enabled when global agent defaults set `blockStreamingDefault: \"on\"`. Email should always batch the full response.\n2. **Unnatural quoting**: Quoted replies look robotic — no `<blockquote>` HTML styling, no `>` prefix in plain text, quotes go through markdown parsing which mangles them.\n3. **Missing configurability**: Auto-archive on reply is hardcoded with no way to disable.\n4. **gog coupling**: All Gmail operations spawn child processes via `gog` CLI. Long-term, a library/SDK approach would be cleaner.\n\n## Architecture\n\n- **Extension entry**: `index.ts` → registers `gmailPlugin` via `api.registerChannel()`\n- **Core files**: `channel.ts` (plugin def + gateway), `outbound.ts` (reply sending), `quoting.ts` (thread quote building), `inbound.ts` (email parsing), `monitor.ts` (polling), `sanitize.ts` (inbound HTML-to-plain-text conversion for LLM consumption)\n- **Dispatch**: Uses `runtime.channel.reply.dispatchReplyWithBufferedBlockDispatcher()` at `channel.ts:132`\n- **Outbound flow**: `sendGmailText()` in `outbound.ts` builds body, optionally appends quotes, converts to HTML via `marked` + `sanitize-html` npm package (inline at outbound.ts:147-153), sends via `gog gmail send`\n- **Quoting flow**: `fetchQuotedContext()` in `quoting.ts` fetches thread via `gog gmail thread get`, extracts last non-self message, formats as `On <date>, <sender> wrote:\\n\\n<body>`\n\n## Key Files\n\n- `src/channel.ts` — Plugin definition, capabilities, gateway, dispatch (365 lines)\n- `src/outbound.ts` — Reply composition and sending (176 lines)\n- `src/quoting.ts` — Thread quote building (231 lines)\n- `src/sanitize.ts` — Inbound HTML-to-plain-text conversion (strips tracking pixels, footers, signatures) (166 lines)\n- `src/outbound-check.ts` — Thread recipient validation (234 lines)\n- `src/monitor.ts` — Polling-based email sync (473 lines)\n- `src/config.ts` — Zod schemas for GmailConfig and GmailAccountSchema (33 lines)\n\n## OpenClaw Core Integration Points\n\n- Block streaming controlled by `replyOptions.disableBlockStreaming` passed to dispatcher\n- `textChunkLimit: 8000` set on plugin outbound config (`channel.ts:228`)\n- Agent prompt hints at `channel.ts:277-294` guide LLM behavior for email context\n- Core default chunk limit is 4000 chars; plugin's 8000 may not propagate to block streaming resolution for extension channels\n\n## Config Key Convention\n\nOpenClaw channels use the plugin ID as the config key under `cfg.channels`. The convention is `cfg.channels?.gmail`. Note: there is a pre-existing inconsistency in the codebase where `outbound.ts:49` reads config as `cfg.channels?.gmail` but `channel.ts:214` writes with `sectionKey: \"openclaw-gmail\"`. Follow the existing read pattern (`cfg.channels?.gmail`) for new config access.\n\n## Build & Test\n\n- No build script — the project is loaded as raw `.ts` by the OpenClaw runtime via a loader (Jiti)\n- `package.json` `main` field is `index.ts` (not compiled JS)\n- `peerDependencies` requires `openclaw >= 2026.1.0`\n- Test files exist: `src/sanitize.test.ts`, `src/outbound-check.test.ts` (run via the OpenClaw test harness or directly with a compatible test runner)\n- No standalone `npm test` script — verify changes by inspecting TypeScript types and running tests via the host project\n\n## Recommended Execution Order\n\n1. **gmail-1.1** (block streaming) — isolated to `channel.ts`, no overlap\n2. **gmail-1.3** (auto-archive config) — small, surgical change in `outbound.ts`\n3. **gmail-1.2** (quoting overhaul) — large restructure of `outbound.ts` and `quoting.ts`, do last to avoid line-number drift","status":"closed","priority":1,"issue_type":"epic","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T12:29:32.106228777+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T13:20:24.314953506+13:00","closed_at":"2026-02-22T13:20:24.314953506+13:00","close_reason":"All child tasks complete. Quality improvements shipped, googleapis migration tracked under gmail-2."}
{"id":"gmail-1.1","title":"Disable block streaming for email delivery","description":"## Problem\n\nWhen a user's OpenClaw config has `agents.defaults.blockStreamingDefault: \"on\"` (common for chat channels), Gmail sessions also stream block replies. Each flushed block triggers a separate `deliver()` call, which sends a **separate email**. This causes agent responses to be fragmented across multiple emails.\n\nThe block streaming coalescer has a 1-second idle timeout — if the agent pauses for >1s during generation (thinking, tool calls), the buffer flushes and sends what it has as a separate email.\n\n## Root Cause\n\n`channel.ts:132-142` calls `dispatchReplyWithBufferedBlockDispatcher` without passing `replyOptions.disableBlockStreaming`. Block streaming resolution in OpenClaw core (`get-reply-directives.ts:358-372`) checks:\n1. `opts.disableBlockStreaming` (not set by gmail)\n2. `agentCfg.blockStreamingDefault` (user's global setting)\n3. Falls back to \"off\"\n\nIf the user has streaming enabled globally, gmail inherits it.\n\n## Fix\n\nIn `src/channel.ts`, the dispatcher call at lines 132-142 currently looks like:\n\n```typescript\nawait runtime.channel.reply.dispatchReplyWithBufferedBlockDispatcher({\n  ctx: ctxPayload,\n  cfg,\n  dispatcherOptions: {\n    deliver,\n    humanDelay,\n    onError: (err: unknown, info: { kind: string }) => {\n      log?.error(`[gmail][${requestId}] ${info.kind} reply failed: ${String(err)}`);\n    },\n  },\n});\n```\n\nAdd `replyOptions` as a **sibling key** to `ctx`, `cfg`, and `dispatcherOptions` in the same object:\n\n```typescript\nawait runtime.channel.reply.dispatchReplyWithBufferedBlockDispatcher({\n  ctx: ctxPayload,\n  cfg,\n  dispatcherOptions: {\n    deliver,\n    humanDelay,\n    onError: (err: unknown, info: { kind: string }) => {\n      log?.error(`[gmail][${requestId}] ${info.kind} reply failed: ${String(err)}`);\n    },\n  },\n  replyOptions: {\n    disableBlockStreaming:\n      typeof gmailCfg?.blockStreaming === \"boolean\"\n        ? !gmailCfg.blockStreaming\n        : true,  // Default: disabled for email\n  },\n});\n```\n\nNote: `gmailCfg` is not currently available in the `dispatchGmailMessage` function scope. You need to resolve it from `cfg` the same way `outbound.ts:49` does:\n\n```typescript\nconst gmailCfg = cfg.channels?.gmail as GmailConfig | undefined;\n```\n\nImport `GmailConfig` from `./config.js` (already exported from that module).\n\n### Config schema updates\n\nAdd `blockStreaming` to the Zod schema in `src/config.ts` (`GmailConfigSchema` or top-level channel config) as an optional boolean.\n\nAlso add it to the JSON schema in `channel.ts` under `configSchema.schema.properties`:\n\n```typescript\nblockStreaming: { type: \"boolean\", default: false },\n```\n\n### Config key note\n\nThe extension reads config from `cfg.channels?.gmail` (see `outbound.ts:49`). Use this same path for the `blockStreaming` config. There is a pre-existing inconsistency where `channel.ts:214` writes with `sectionKey: \"openclaw-gmail\"` — do not change that; just follow the existing read pattern.\n\nThis approach follows the WhatsApp pattern in OpenClaw core (`web/auto-reply/monitor/process-message.ts:416-422`).\n\n## Testing\n\n1. Set `agents.defaults.blockStreamingDefault: \"on\"` in OpenClaw config\n2. Send an email that triggers a long agent response (e.g., ask for a detailed explanation)\n3. Verify the response arrives as a single email, not multiple\n4. Set `channels.gmail.blockStreaming: true` in config and verify streaming is re-enabled\n5. Remove both settings and verify default behavior (no streaming)\n\n## Acceptance Criteria\n\n- [ ] Gmail replies always arrive as a single email by default\n- [ ] `channels.gmail.blockStreaming` config option respected (boolean, default false)\n- [ ] No change to behavior when block streaming is globally off (already works correctly)\n- [ ] `blockStreaming` added to Zod schema in `config.ts` and JSON schema in `channel.ts`\n","status":"closed","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T12:29:50.680569023+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T13:20:16.421488829+13:00","closed_at":"2026-02-22T13:20:16.421488829+13:00","close_reason":"Implemented: replyOptions.disableBlockStreaming added to dispatcher call","labels":["outbound","block-streaming","P0"],"dependencies":[{"issue_id":"gmail-1.1","depends_on_id":"gmail-1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-1.2","title":"Implement native Gmail-style HTML blockquote quoting","description":"## Problem\n\nQuoted replies in agent emails look robotic and unnatural compared to native Gmail quoting. Two issues:\n\n1. **No visual quote styling**: Quotes are plain text appended to the reply body with just a `On <date>, <sender> wrote:` header. No `<blockquote>` HTML, no border-left styling, no `gmail_quote` CSS class. Recipients see the quoted text as indistinguishable from the reply itself.\n\n2. **Quotes go through markdown parsing**: In `outbound.ts:135`, the quote is concatenated to the reply text BEFORE `marked.parse()` runs at line 146. This means the quoted email content gets markdown-interpreted — `*asterisks*` become italic, `#` becomes headings, URLs get auto-linked differently, etc.\n\n### Current flow (outbound.ts:80-159)\n\n```\nreply text + \"\\n\\n\" + quoted text  ->  marked.parse()  ->  sanitize-html  ->  gog send --body-html\n```\n\n### Desired flow\n\n```\nreply text  ->  marked.parse()  ->  sanitize-html  ->  append Gmail-style <blockquote> HTML  ->  gog send --body-html\n```\n\n## Fix\n\n### A. Restructure outbound.ts\n\nSeparate reply body processing from quote construction. The key change is in the `sendGmailText()` function:\n\n1. Parse **only the reply text** through `marked` + `sanitize-html` to get reply HTML (currently at lines 144-159)\n2. Build quote HTML separately using proper Gmail structure:\n   ```html\n   <div class=\"gmail_quote\">\n     <div dir=\"ltr\" class=\"gmail_attr\">On Mon, Feb 22, 2026 at 2:15 PM, John Doe wrote:</div>\n     <blockquote class=\"gmail_quote\" style=\"margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex\">\n       [original message HTML, sanitized]\n     </blockquote>\n   </div>\n   ```\n3. Concatenate: `replyHtml + quoteHtml` for `--body-html`\n4. For `--body` (plain text): `reply text + \"\\n\\n\" + \"On <date>, <sender> wrote:\\n\" + \"> \" prefixed quote lines`\n\nCurrently the quote text and reply text are concatenated at line 135 (`body = \\`${text}\\n\\n${quotedContext}\\``), then the combined string goes through `marked.parse()` at line 146. The restructured flow should NOT concatenate them before markdown parsing.\n\n### B. Update quoting.ts — return structured data\n\n`fetchQuotedContext()` (lines 219-230) currently returns a pre-formatted string. Change it to return structured data so `outbound.ts` can build HTML and plain text separately:\n\n```typescript\nexport interface QuotedContent {\n  header: string;        // \"On Mon, Feb 22, 2026 at 2:15 PM, John Doe wrote:\"\n  bodyHtml: string;      // Sanitized HTML from original message\n  bodyPlain: string;     // Plain text from original message\n}\n```\n\n**There is exactly one call site** for `fetchQuotedContext`: `outbound.ts:129-136`. Update it to consume the new `QuotedContent` return type.\n\n### C. Update quoting.ts — extract HTML body\n\nThe current `extractBody()` function (lines 55-68) only extracts `text/plain` MIME parts. Add a new `extractHtmlBody()` that extracts the `text/html` MIME part for richer quotes:\n\n```typescript\nfunction extractHtmlBody(msg: GogRawMessage): string {\n  if (msg.payload.parts) {\n    const htmlPart = msg.payload.parts.find((p) => p.mimeType === \"text/html\");\n    if (htmlPart?.body?.data) {\n      return Buffer.from(htmlPart.body.data, \"base64\").toString(\"utf-8\");\n    }\n  }\n  if (msg.payload.body?.data) {\n    return Buffer.from(msg.payload.body.data, \"base64\").toString(\"utf-8\");\n  }\n  return \"\";\n}\n```\n\n### D. Sanitize HTML quotes before embedding\n\nThe HTML from the original message needs sanitization before embedding in the blockquote (strip scripts, tracking pixels, event handlers). Use the `sanitize-html` npm package (already a dependency — see `outbound.ts:3`) with permissive tag settings to preserve formatting (bold, links, lists, etc.) while removing dangerous content.\n\nNote: `src/sanitize.ts` is an **inbound** HTML-to-plain-text converter (for LLM consumption). It is NOT for HTML sanitization. Do not modify it for this task. Use the `sanitize-html` npm package directly for quote HTML sanitization.\n\n### E. Update quoteBody() for plain text\n\nThe `quoteBody()` function at `quoting.ts:181-183` is currently a no-op passthrough:\n```typescript\nfunction quoteBody(body: string): string {\n  return body;\n}\n```\n\nUpdate it to add `> ` prefix to each line for proper plain text quoting.\n\n## Files to modify\n\n- `src/quoting.ts` — Return structured `QuotedContent`, add `extractHtmlBody()`, fix `quoteBody()` for plain text\n- `src/outbound.ts` — Restructure to build HTML and plain text separately, append blockquote HTML after markdown parsing\n\n## Build & Test\n\nThis project has no standalone build script — it is loaded as raw `.ts` by the OpenClaw runtime via Jiti. There is no `npm test` command. Verify changes by:\n- Checking TypeScript types are correct (no compile errors)\n- Manually testing by sending an email reply through the OpenClaw runtime\n- Visually confirming the quote renders with Gmail-native blockquote styling in a real email client\n\n## Acceptance Criteria\n\n- [ ] Quoted replies render with Gmail-native `<blockquote>` styling (border-left, indentation)\n- [ ] Original message formatting (bold, links, lists) preserved in HTML quotes\n- [ ] Plain text `--body` uses `> ` prefix quoting\n- [ ] Quote text is NOT processed through markdown parser\n- [ ] Existing `includeQuotedReplies` config toggle (outbound.ts:67-69) still works\n- [ ] Single call site at `outbound.ts:129` updated to handle new `QuotedContent` return type\n- [ ] Visual verification: send a test reply and confirm quote looks native in Gmail/Outlook (manual test)\n","status":"closed","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T12:30:15.875489376+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T13:20:17.45957889+13:00","closed_at":"2026-02-22T13:20:17.45957889+13:00","close_reason":"Implemented: Gmail-style blockquote quoting with structured QuotedContent","labels":["quoting","outbound","P0"],"dependencies":[{"issue_id":"gmail-1.2","depends_on_id":"gmail-1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-1.3","title":"Make auto-archive on reply configurable","description":"## Problem\n\nIn `outbound.ts:163-173`, every thread reply automatically removes the `INBOX` label (archives the thread). This is hardcoded with no way to disable it.\n\n```typescript\nif (isThread) {\n  const archiveArgs = [\"gmail\", \"labels\", \"modify\", toValue];\n  if (account.email) archiveArgs.push(\"--account\", account.email);\n  archiveArgs.push(\"--remove\", \"INBOX\");\n  spawnGog(archiveArgs).catch((err) => {\n    console.error(`Failed to archive thread ${toValue}: ${err.message}`);\n  });\n}\n```\n\nSome users may want threads to remain in their inbox after the agent replies, especially for oversight/review workflows.\n\n## Fix\n\n### 1. Add config resolution in `outbound.ts`\n\nUse the existing `gmailCfg` (line 49) and `accountCfg` (line 66) variables already in scope within `sendGmailText()`:\n\n```typescript\n// These already exist in sendGmailText():\n// outbound.ts:49 -> const gmailCfg = cfg.channels?.gmail as GmailConfig | undefined;\n// outbound.ts:66 -> const accountCfg = gmailCfg?.accounts?.[accountId || \"default\"];\n\n// Add after the existing config resolution block (~line 78):\nconst archiveOnReply = accountCfg?.archiveOnReply\n  ?? gmailCfg?.defaults?.archiveOnReply\n  ?? true;\n```\n\nThen wrap the archive block at lines 163-173:\n\n```typescript\nif (isThread && archiveOnReply) {\n  // ... existing archive logic unchanged\n}\n```\n\n### 2. Update Zod schema in `src/config.ts`\n\nAdd `archiveOnReply` as an optional boolean to:\n- The account schema (per-account override)\n- The defaults schema (global default)\n\n### 3. Update JSON schema in `src/channel.ts`\n\nAdd to `configSchema.schema.properties.accounts.additionalProperties.properties`:\n```typescript\narchiveOnReply: { type: \"boolean\", default: true },\n```\n\nAnd to `configSchema.schema.properties.defaults.properties`:\n```typescript\narchiveOnReply: { type: \"boolean\", default: true },\n```\n\n## Config key note\n\nConfig is read from `cfg.channels?.gmail` (see `outbound.ts:49`). Follow this existing pattern. There is a pre-existing inconsistency where `channel.ts:214` writes with `sectionKey: \"openclaw-gmail\"` — do not change that.\n\n## Files to modify\n\n- `src/outbound.ts` — Add config check before archive (use existing `gmailCfg` at line 49 and `accountCfg` at line 66)\n- `src/config.ts` — Add `archiveOnReply` to Zod schema\n- `src/channel.ts` — Add `archiveOnReply` to JSON configSchema\n\n## Acceptance Criteria\n\n- [ ] `archiveOnReply: false` in account or defaults config prevents archiving\n- [ ] Default behavior unchanged (archives on reply when not configured)\n- [ ] Config resolution follows existing pattern: account -> defaults -> true\n- [ ] Both Zod schema (`config.ts`) and JSON schema (`channel.ts`) updated\n","status":"closed","priority":2,"issue_type":"feature","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T12:30:30.217843004+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T13:20:18.541730523+13:00","closed_at":"2026-02-22T13:20:18.541730523+13:00","close_reason":"Implemented: archiveOnReply config at account and defaults level","labels":["outbound","config","P1"],"dependencies":[{"issue_id":"gmail-1.3","depends_on_id":"gmail-1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-1.4","title":"Evaluate migrating from gog CLI to googleapis library","description":"## Context\n\nAll Gmail API operations in the extension spawn `gog` (a Go CLI tool by steipete/gogcli) as child processes. This works but has overhead: ~50-200ms per-call (process spawn + Go binary startup), string-based error handling, no connection reuse, and fragile child process lifecycle management.\n\n## Research Findings\n\n### gog\n\n- Go CLI tool at `/home/jakemc/bin/gog` (v0.9.0), installed via Homebrew\n- **No library/SDK mode** — CLI-only, no importable Go library or Node.js SDK\n- Active maintenance (GitHub: steipete/gogcli, 78 open issues)\n- OAuth tokens stored in encrypted JWE keyring at `~/.config/gogcli/keyring/`\n- OAuth client_id/client_secret stored in plaintext at `~/.config/gogcli/credentials.json`\n- 15+ spawn calls across the extension codebase for different operations\n\n### googleapis (official Google API client for Node.js)\n\n- npm package `googleapis` — millions of weekly downloads, Google-maintained\n- Full TypeScript types, 1:1 mapping to Gmail REST API\n- Auth via `google-auth-library` with automatic token refresh\n- **Can reuse gog's existing OAuth client_id/client_secret** from `credentials.json`\n- Would need a one-time re-authorization to get a new refresh_token (same GCP project, same consent screen)\n- In-process calls, HTTP/2 keep-alive, typed exceptions, proper async\n\n### Comparison\n\n| Metric | gog CLI | googleapis |\n|--------|---------|------------|\n| Per-call overhead | ~50-200ms | ~0ms |\n| Error handling | Parse stderr | Typed exceptions |\n| Connection reuse | None | HTTP/2 keep-alive |\n| MIME construction | Handled by gog | Manual (use mailcomposer/nodemailer builder) |\n| Watch/push server | Built-in `gog gmail watch serve` | Need own HTTP endpoint (gateway already exists) |\n| Auth flow | `gog auth add` | Implement OAuth flow or extract existing token |\n\n### Migration Phases\n\n1. **Phase 1 (low effort)**: Replace simple spawn calls in extension (send, thread get, search, labels). ~2-4 hours per command.\n2. **Phase 2 (medium effort)**: Replace `gog gmail watch serve` with direct `googleapis` + gateway HTTP endpoint. ~1-2 days. Eliminates fragile child process lifecycle management.\n3. **Phase 3 (auth)**: Reuse existing client_id/secret, implement one-time OAuth flow for new refresh_token, store in OpenClaw config. ~2-4 hours.\n\n### Key Risk\n\nMIME message construction for send/reply is non-trivial. gog handles RFC 2822 formatting internally. With googleapis, need to construct MIME messages ourselves (libraries like `mailcomposer` help but add complexity).\n\n### Impact on Users\n\n- **If gog stays**: Users keep existing auth setup, no migration needed\n- **If googleapis replaces gog**: Users need a one-time re-authorization (browser popup, same GCP project). The painful OAuth app setup (GCP project, consent screen, scopes) is NOT repeated — only the token exchange.\n\n## Decision Needed\n\nWhether to migrate and on what timeline. Current recommendation: keep gog for now, track googleapis migration as a future improvement. The extension's current issues (block streaming, quoting) are independent of the transport layer.\n\n## Status\n\nResearch complete. No action required until a decision is made.","status":"closed","priority":3,"issue_type":"decision","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T12:32:47.226802977+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T13:20:23.118113305+13:00","closed_at":"2026-02-22T13:20:23.118113305+13:00","close_reason":"Decision: proceed with googleapis migration. Research complete, beads created under gmail-2.","labels":["gog","architecture","research"],"dependencies":[{"issue_id":"gmail-1.4","depends_on_id":"gmail-1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2","title":"Migrate from gog CLI to googleapis","description":"## Context\n\nThe openclaw-gmail extension currently spawns the `gog` Go CLI tool for all Gmail API operations (~15+ spawn calls across 5 files). This works but has overhead: ~50-200ms per call (process spawn + Go startup), string-based error handling, no connection reuse, and fragile child process lifecycle management.\n\nDecision made to migrate to `@googleapis/gmail` npm package (standalone, ~1.15 MB) + `google-auth-library` for OAuth + `nodemailer` MailComposer for MIME construction.\n\n## Verified Dependencies (Feb 2026 review)\n\n- `@googleapis/gmail@16.1.1` — Standalone Gmail API client (~1.15 MB unpacked, 88 transitive packages). NOT the full 200 MB `googleapis` bundle. All required API methods verified: `users.threads.get`, `users.messages.get/list/send/modify`, `users.labels.list/create`, `users.messages.attachments.get`, `users.settings.sendAs.list`.\n- `google-auth-library@10.5.0` — Already in the dependency tree as transitive dep of `gaxios` (via `@google/genai`). OAuth2Client supports `generateAuthUrl()` with `access_type: 'offline'` + `prompt: 'consent'`, automatic token refresh, and `getToken()` returning `refresh_token`.\n- `nodemailer` — MailComposer importable from `nodemailer/lib/mail-composer`. Supports `from`, `to`, `cc`, `subject`, `text`, `html`, `inReplyTo`, `references`. `compile().build()` produces valid RFC 2822/5322 buffer suitable for base64url encoding and passing to `messages.send({ raw })`.\n\n## Architecture\n\n### Transport Abstraction\nIntroduce a `GmailClient` interface with two implementations:\n- `GogGmailClient` — Current implementation wrapping gog CLI spawn calls\n- `ApiGmailClient` — New implementation using @googleapis/gmail directly\n\nPer-account `backend` config selects which client to use. Default: `\"api\"` for new users, existing users keep gog until they opt in.\n\n### Auth Strategy\n- Users provide their own GCP OAuth client_id/client_secret (same as gog requires today)\n- For existing gog users: read client_id/secret from `~/.config/gogcli/credentials.json`, do one-time re-auth for our own refresh_token\n- For new users: guide through GCP OAuth setup, then standard browser OAuth flow\n- Store refresh_token in OpenClaw config (encrypted section) or dedicated token file\n- JWE keyring extraction NOT pursued (too fragile, OS-keychain-dependent)\n\n### Gog spawn inventory (verified)\n\nTwo wrapper functions handle all spawning:\n- `spawnGog()` (outbound.ts:17-44) — Write ops, retry w/ backoff, void return, 30s timeout\n- `runGog()` (monitor.ts:70-125) — Read ops, circuit breaker (per-account, exponential backoff up to 15min), returns parsed JSON, 30s timeout, 10MB buffer\n\nThree files use direct `spawn(\"gog\")` instead of wrappers:\n- quoting.ts:119-170 — `fetchThread()`, 15s timeout\n- outbound-check.ts:22-102 — `fetchThreadData()`, 10s timeout\n- onboarding.ts:50-59 — `authorizeGog()`, interactive `stdio: \"inherit\"`\n\nFour exec-based calls in onboarding.ts:\n- `command -v gog` (line 13), `gog --version` (line 21), `gog auth list --plain` (line 41), `gog gmail settings sendas list` (line 61)\n\nOne exec-based call in monitor.ts:\n- `gog --version` (line 61), `gog gmail attachment` (line 276)\n\n### Files with gog spawn calls to replace\n- `src/outbound.ts` — `spawnGog()`: gmail send, labels modify (archive)\n- `src/monitor.ts` — `runGog()`: messages search, get, labels modify/list/create, thread modify, search, attachment; `execFileAsync()`: gog --version, gmail attachment\n- `src/quoting.ts` — `fetchThread()`: gmail thread get --full\n- `src/outbound-check.ts` — `fetchThreadData()`: gmail thread get\n- `src/onboarding.ts` — gog version check, auth list/add, settings sendas list\n- `src/channel.ts` — Agent prompt hint referencing gog attachment command\n\n### Internal types inventory (verified)\n\n| Type | Location | Used by |\n|------|----------|--------|\n| `GogPayload` | inbound.ts:6-25 | parseInboundGmail() |\n| `GogMessagePart` | inbound.ts:18-25 | Attachment/body extraction |\n| `GogSearchMessage` | inbound.ts:105-113 | performFullSync() |\n| `GogRawMessage` | quoting.ts:39-49 | Thread message parsing |\n| `GogThreadOutput` | quoting.ts:30-37 | fetchThread() |\n| `ThreadResponse` | quoting.ts:23-27 | fetchQuotedContext() |\n| `ThreadMessage` | quoting.ts:10-21 | Individual parsed message |\n| `ThreadData` | outbound-check.ts:14-17 | validateThreadReply() |\n| `ThreadParticipant` | outbound-check.ts:9-12 | Participant extraction |\n| `GmailAttachment` | attachments.ts:3-8 | Attachment metadata |\n\n### Latent bug found during review\n\n`monitor.ts:154` accesses `account.sessionTtlDays` but this field is NOT defined in `GmailAccountSchema` (config.ts), `ResolvedGmailAccount` (accounts.ts), or the JSON schema (channel.ts). Low priority but should be addressed.\n\n## Recommended Execution Order\n\n1. **gmail-2.1** (GmailClient interface + gog backend) — Extract interface, no behavior change\n2. **gmail-2.2** (OAuth + token management) — Auth flow, credential storage, gog cred reuse\n3. **gmail-2.3** (API client: read ops) — Implement thread get, message get/search/list, labels, attachments\n4. **gmail-2.4** (API client: write ops + MIME) — Implement send, reply, reply-all with MailComposer, label modify\n5. **gmail-2.5** (Onboarding overhaul) — Update onboarding flow for both new and existing gog users","status":"open","priority":1,"issue_type":"epic","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T13:20:50.144705221+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T23:00:00+13:00","labels":["architecture","googleapis","migration"]}
{"id":"gmail-2.1","title":"Extract GmailClient interface and wrap gog in GogGmailClient","description":"## Goal\n\nCreate a transport abstraction layer so the rest of the codebase talks to a typed interface rather than spawning gog directly. Pure refactor — zero behavior change, zero new dependencies.\n\nBroken into 3 subtasks: gmail-2.1.1 (interface + implementation), gmail-2.1.2 (migrate outbound path), gmail-2.1.3 (migrate monitor + wire up channel).\n\n## Refined Interface (from code review)\n\n```typescript\nexport interface GmailClient {\n  // Write ops\n  send(opts: { account?: string; to?: string; subject: string; textBody: string; htmlBody?: string; threadId?: string; replyToMessageId?: string; replyAll?: boolean }): Promise<void>;\n  modifyLabels(id: string, opts: { add?: string[]; remove?: string[] }): Promise<void>;\n  modifyThreadLabels(threadId: string, opts: { add?: string[]; remove?: string[] }): Promise<void>;\n  createLabel(name: string): Promise<void>;\n\n  // Read ops\n  getThread(threadId: string, opts?: { full?: boolean }): Promise<ThreadResponse | null>;\n  getMessage(messageId: string): Promise<Record<string, unknown> | null>;\n  searchMessages(query: string, opts?: { maxResults?: number; includeBody?: boolean }): Promise<GogSearchMessage[]>;\n  searchThreads(query: string, opts?: { maxResults?: number }): Promise<Record<string, unknown> | null>;\n  listLabels(): Promise<{ id: string; name: string }[]>;\n  downloadAttachment(messageId: string, attachmentId: string, outPath: string): Promise<void>;\n  getSendAs(): Promise<{ displayName?: string; email: string; isPrimary?: boolean }[]>;\n}\n```\n\nKey changes from original spec:\n- `send()` returns `Promise<void>` (gog doesn't return messageId)\n- `getMessage()` returns `Record<string, unknown> | null` (matches current `runGog` return; consumers cast)\n- Added `searchThreads()` for `gmail search` (thread-listing format used for historyId at monitor.ts:382)\n- `searchMessages()` returns `GogSearchMessage[]` directly (reuses existing type from inbound.ts:105-113)\n- Removed `from`/`inReplyTo`/`references` from `send()` — gog resolves these internally from `--reply-to-message-id`\n\n## Implementation details\n\n### GogGmailClient (src/gog-client.ts)\n\nTwo private execution methods:\n- `execGog(args, retries=3)` — write ops via `spawn()`, 30s timeout, 3 retries w/ 1s/2s delay (from outbound.ts:17-44)\n- `runGog(args, retries=3)` — read ops via `execFileAsync()`, prepends `--json --account`, 30s timeout, 10MB buffer, circuit breaker, returns parsed JSON (from monitor.ts:70-125)\n\nCircuit breaker as instance state (not module-level Map). Config: maxFailures=3, initialBackoffMs=60s, maxBackoffMs=15min. Opens on 403/invalid_grant/ETIMEDOUT/500. 404 returns null silently.\n\nStatic `GogGmailClient.checkExists()` for gog version check (monitor startup).\n\n### quoting.ts changes\n\nExport `GogRawMessage`, `GogThreadOutput` types and new `parseGogThreadOutput(data: unknown): ThreadResponse | null` (extracts lines 144-160 from `fetchThread`). Remove `fetchThread()`. Update `fetchQuotedContext()` third param from `accountArg?: string` to `client: GmailClient`.\n\n### outbound-check.ts changes\n\nRemove `fetchThreadData()` (lines 22-101). Update `validateThreadReply()` to accept `client: GmailClient`, call `client.getThread(threadId)`, then extract participants from `ThreadMessage[]` using existing `parseEmailAddresses()`. The participant extraction logic (lines 64-84) stays but operates on `ThreadMessage` headers instead of raw gog output.\n\n### outbound.ts changes\n\nRemove `spawnGog()` (lines 17-44). Add `client: GmailClient` to `GmailOutboundContext`. Replace gog args building (lines 59-173) with `client.send({ ... })`. Replace archive spawn (lines 180-187) with `client.modifyLabels(toValue, { remove: [\"INBOX\"] })`. Update `fetchQuotedContext()` and `validateThreadReply()` calls to pass client.\n\n### monitor.ts changes\n\nRemove `runGog()`, `getCircuit()`, `circuitStates`, `CircuitState`, `CIRCUIT_CONFIG` (all moved to gog-client.ts). Keep `checkGogExists()` with local `execFileAsync` (startup health check). Add `client: GmailClient` to `monitorGmail()` params. Thread client through all internal functions.\n\n### channel.ts changes\n\nCreate client in `startAccount()`: `const client = createGmailClient(ctx.account)`. Store in `activeClients: Map<string, GmailClient>`. Pass through `monitorGmail()`, `dispatchGmailMessage()`, `handleAction()`. Update agent prompt hint (line 304) to not hardcode gog attachment command. Add `backend` to JSON schema.\n\n## Acceptance Criteria\n\n- [ ] `GmailClient` interface covers all gog operations (except onboarding)\n- [ ] `GogGmailClient` preserves circuit breaker, retry, and timeout behavior\n- [ ] All 5 consumer files use client (outbound, monitor, quoting, outbound-check, channel)\n- [ ] `createGmailClient()` factory returns GogGmailClient\n- [ ] `backend` config field added to Zod + JSON schemas\n- [ ] Zero behavior change, zero new dependencies","status":"closed","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T13:21:12.169784128+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T19:59:20.696620897+13:00","closed_at":"2026-02-22T19:59:20.696620897+13:00","close_reason":"Closed","labels":["architecture","refactor"],"dependencies":[{"issue_id":"gmail-2.1","depends_on_id":"gmail-2","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.1.1","title":"Create GmailClient interface, GogGmailClient class, and factory","description":"## Goal\n\nCreate the new abstraction layer files and prepare quoting.ts exports needed by the client.\n\n## New files\n\n### `src/gmail-client.ts`\n\nDefines `GmailClient` interface and `createGmailClient()` factory.\n\n```typescript\nexport interface GmailClient {\n  send(opts: { account?: string; to?: string; subject: string; textBody: string; htmlBody?: string; threadId?: string; replyToMessageId?: string; replyAll?: boolean }): Promise<void>;\n  getThread(threadId: string, opts?: { full?: boolean }): Promise<ThreadResponse | null>;\n  getMessage(messageId: string): Promise<Record<string, unknown> | null>;\n  searchMessages(query: string, opts?: { maxResults?: number; includeBody?: boolean }): Promise<GogSearchMessage[]>;\n  searchThreads(query: string, opts?: { maxResults?: number }): Promise<Record<string, unknown> | null>;\n  modifyLabels(id: string, opts: { add?: string[]; remove?: string[] }): Promise<void>;\n  modifyThreadLabels(threadId: string, opts: { add?: string[]; remove?: string[] }): Promise<void>;\n  listLabels(): Promise<{ id: string; name: string }[]>;\n  createLabel(name: string): Promise<void>;\n  downloadAttachment(messageId: string, attachmentId: string, outPath: string): Promise<void>;\n  getSendAs(): Promise<{ displayName?: string; email: string; isPrimary?: boolean }[]>;\n}\n```\n\nFactory: `createGmailClient(account: ResolvedGmailAccount): GmailClient` — returns `new GogGmailClient(account.email)`.\n\n### `src/gog-client.ts`\n\n`GogGmailClient` class implementing `GmailClient`. Constructor takes `accountEmail: string`.\n\nTwo private execution methods:\n- `execGog(args, retries=3): Promise<void>` — write ops via `spawn()`, 30s timeout, 3 retries w/ 1s/2s delay. Exact logic from `outbound.ts:17-44`.\n- `runGog(args, retries=3): Promise<Record<string, unknown> | null>` — read ops via `execFileAsync()`, prepends `--json --account <email>`, 30s timeout, 10MB buffer, circuit breaker, returns parsed JSON. Exact logic from `monitor.ts:70-125`.\n\nCircuit breaker as instance state:\n```typescript\nprivate circuit: CircuitState = { consecutiveFailures: 0, lastFailureAt: 0, backoffUntil: 0 };\n```\nConfig: maxFailures=3, initialBackoffMs=60_000, maxBackoffMs=15*60_000. Opens on 403/invalid_grant/ETIMEDOUT/500. 404 returns null.\n\nStatic method: `GogGmailClient.checkExists(): Promise<boolean>` — runs `execFileAsync(\"gog\", [\"--version\"])`.\n\nPublic methods map to gog commands:\n- `send()` → builds `gmail send` args from opts, calls `execGog()`\n- `getThread()` → `runGog([\"gmail\", \"thread\", \"get\", id, \"--full\"])` + `parseGogThreadOutput()`\n- `getMessage()` → `runGog([\"gmail\", \"get\", id])`\n- `searchMessages()` → `runGog([\"gmail\", \"messages\", \"search\", query, \"--include-body\", \"--max\", n])`, extracts `.messages`\n- `searchThreads()` → `runGog([\"gmail\", \"search\", query, \"--max\", n])`\n- `modifyLabels()` → `runGog([\"gmail\", \"labels\", \"modify\", id, \"--add\"/\"--remove\" ...])`\n- `modifyThreadLabels()` → `runGog([\"gmail\", \"thread\", \"modify\", id, \"--add\"/\"--remove\" ...])`\n- `listLabels()` → `runGog([\"gmail\", \"labels\", \"list\"])`, extracts `.labels`\n- `createLabel()` → `runGog([\"gmail\", \"labels\", \"create\", name])`\n- `downloadAttachment()` → `execFileAsync(\"gog\", [\"gmail\", \"attachment\", ...])` (no circuit breaker)\n- `getSendAs()` → `runGog([\"gmail\", \"settings\", \"sendas\", \"list\"])`, extracts `.sendAs`\n\n## Modified files\n\n### `src/quoting.ts`\n\n- **Export** `GogRawMessage` and `GogThreadOutput` types (currently private)\n- **Export** new `parseGogThreadOutput(data: unknown): ThreadResponse | null` — extracts parsing logic from `fetchThread()` lines 144-160. Parses `{ downloaded, thread: { id, historyId, messages[] } }` structure, maps messages via existing `parseGogMessage()`.\n- `fetchThread()` stays for now (removed in gmail-2.1.2)\n\n### `src/config.ts`\n\n- Add `backend: z.enum([\"gog\", \"api\"]).optional()` to `GmailAccountSchema`\n\n### `src/channel.ts` (JSON schema only)\n\n- Add `backend: { type: \"string\", enum: [\"gog\", \"api\"] }` to account properties in `configSchema`\n\n## Acceptance Criteria\n\n- [ ] `GmailClient` interface defined in gmail-client.ts\n- [ ] `GogGmailClient` implements all methods with preserved retry/circuit breaker logic\n- [ ] `parseGogThreadOutput()` exported from quoting.ts\n- [ ] `backend` field added to Zod + JSON schemas\n- [ ] No consumers changed yet — existing code still works via direct gog spawns","status":"closed","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T23:30:00+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T19:51:38.594119954+13:00","closed_at":"2026-02-22T19:51:38.594119954+13:00","close_reason":"Closed","labels":["architecture","refactor"],"dependencies":[{"issue_id":"gmail-2.1.1","depends_on_id":"gmail-2.1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.1.2","title":"Migrate outbound path to GmailClient","description":"## Goal\n\nReplace all gog spawns in the outbound path (quoting.ts, outbound-check.ts, outbound.ts) with `GmailClient` method calls. Depends on gmail-2.1.1.\n\n## Changes\n\n### `src/quoting.ts`\n\n- Remove `fetchThread()` function entirely (lines 119-169)\n- Remove `import { spawn }` — no longer needed\n- Update `fetchQuotedContext(threadId, accountEmail, client: GmailClient)` — third param changes from `accountArg?: string` to `client: GmailClient`\n- Body: replace `await fetchThread(threadId, accountArg)` with `await client.getThread(threadId, { full: true })`\n- Add `import type { GmailClient } from \"./gmail-client.js\"`\n\n### `src/outbound-check.ts`\n\n- Remove `fetchThreadData()` function entirely (lines 22-101)\n- Remove `import { spawn }` — no longer needed\n- Update `validateThreadReply(threadId, accountEmail, allowOutboundTo, policy, client: GmailClient)` — add `client` as 5th param\n- Inside: replace `fetchThreadData(threadId, accountEmail)` with:\n  ```typescript\n  const thread = await client.getThread(threadId);\n  if (!thread) throw new Error(\"Could not fetch thread\");\n  // Extract participants from thread.messages using existing parseEmailAddresses()\n  ```\n- The participant extraction logic (currently lines 64-84 inside fetchThreadData's close handler) moves into `validateThreadReply` itself, operating on `ThreadMessage[]` instead of raw gog JSON. Walk messages, extract From/To/Cc from `msg.from`/`msg.to`/`msg.cc` fields, feed through `parseEmailAddresses()`.\n- Add `import type { GmailClient } from \"./gmail-client.js\"` and `import type { ThreadMessage } from \"./quoting.js\"`\n\n### `src/outbound.ts`\n\n- Remove `spawnGog()` function entirely (lines 17-44)\n- Remove `import { spawn }` — no longer needed\n- Add `client: GmailClient` to `GmailOutboundContext` interface\n- Add `import type { GmailClient } from \"./gmail-client.js\"`\n- In `sendGmailText()`:\n  - Replace `validateThreadReply(toValue, account.email, allowOutboundTo, threadReplyPolicy)` → add `ctx.client` as 5th arg\n  - Replace `fetchQuotedContext(toValue, account.email, account.email)` → `fetchQuotedContext(toValue, account.email, ctx.client)`\n  - Replace gog args building + `await spawnGog(args)` (lines 59-173) with `await ctx.client.send({ account: account.email, to: isThread ? undefined : toValue, subject, textBody: plainBody, htmlBody: fullHtml, threadId: isThread ? toValue : undefined, replyToMessageId: replyToId ? String(replyToId) : undefined, replyAll: isThread })`\n  - Replace archive `spawnGog(archiveArgs)` (lines 180-187) with `ctx.client.modifyLabels(toValue, { remove: [\"INBOX\"] })`\n\n## Acceptance Criteria\n\n- [ ] No `spawn` imports remain in quoting.ts, outbound-check.ts, outbound.ts\n- [ ] `fetchThread()` and `fetchThreadData()` and `spawnGog()` removed\n- [ ] `sendGmailText()` uses `client.send()` and `client.modifyLabels()`\n- [ ] `fetchQuotedContext()` and `validateThreadReply()` accept `GmailClient`\n- [ ] `GmailOutboundContext` has `client: GmailClient`\n- [ ] Note: callers in channel.ts not yet updated (done in gmail-2.1.3)","status":"closed","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T23:30:00+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T19:55:14.749803805+13:00","closed_at":"2026-02-22T19:55:14.749803805+13:00","close_reason":"Closed","labels":["outbound","refactor"],"dependencies":[{"issue_id":"gmail-2.1.2","depends_on_id":"gmail-2.1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"gmail-2.1.2","depends_on_id":"gmail-2.1.1","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.1.3","title":"Migrate monitor.ts and wire up client in channel.ts","description":"## Goal\n\nReplace all gog spawns in monitor.ts with `GmailClient` method calls. Wire up client creation and threading in channel.ts. Depends on gmail-2.1.2.\n\n## Changes\n\n### `src/monitor.ts`\n\n- Remove: `runGog()` function (lines 70-125), `getCircuit()` (lines 54-59), `circuitStates` Map (line 52), `CircuitState` interface (lines 40-44), `CIRCUIT_CONFIG` (lines 46-50), `GOG_TIMEOUT_MS` (line 32)\n- Keep: `checkGogExists()` with its own local `execFileAsync` — startup health check, gog-specific\n- Remove `execFileAsync` usage from `downloadAttachmentsIfSmall` (attachment download moves to client)\n- Can remove `const execFileAsync = promisify(execFile)` at line 14 IF checkGogExists is refactored to inline it, OR keep it for checkGogExists only\n- Add `client: GmailClient` to `monitorGmail()` params interface\n- Add `import type { GmailClient } from \"./gmail-client.js\"`\n- Thread `client` through all internal functions:\n  - `quarantineMessage(id, accountEmail, log, client)` → `client.modifyLabels(id, { add: [\"not-allow-listed\"], remove: [\"INBOX\"] })`\n  - `markAsRead(id, threadId, accountEmail, log, client)` → `client.modifyThreadLabels(threadId, { remove: [\"UNREAD\"] })` or `client.modifyLabels(id, { remove: [\"UNREAD\"] })`\n  - `fetchMessageDetails(id, account, log, ignoreLabels, client)` → `client.getMessage(id)` (returns raw record, existing cast to GogPayload stays)\n  - `downloadAttachmentsIfSmall(msg, account, log, client)` → `client.downloadAttachment(msgId, attId, outPath)`\n  - `performFullSync(account, onMessage, signal, log, client)` → `client.searchMessages(...)`, `client.searchThreads(...)`, `client.getMessage(...)`\n  - `ensureQuarantineLabel(accountEmail, log, client)` → `client.listLabels()`, `client.createLabel(...)`\n\n### `src/channel.ts`\n\n- Add imports: `import { createGmailClient, type GmailClient } from \"./gmail-client.js\"`\n- Add module-level: `const activeClients = new Map<string, GmailClient>()`\n- Update `startAccount(ctx)`:\n  ```typescript\n  const client = createGmailClient(ctx.account);\n  if (ctx.account.email) {\n    activeClients.set(ctx.account.email.toLowerCase(), client);\n  }\n  // Pass client to monitorGmail\n  await monitorGmail({ account: ctx.account, onMessage: ..., signal, log, setStatus, client });\n  // Cleanup\n  if (ctx.account.email) { activeClients.delete(ctx.account.email.toLowerCase()); }\n  ```\n- Update `dispatchGmailMessage(ctx, msg, client: GmailClient)` — add client param, pass into `sendGmailText({ ..., client })` in deliver closure\n- Update `handleAction` — resolve client from `activeClients.get(account.email.toLowerCase())`, pass into `sendGmailText({ ..., client })`\n- Update agent prompt hint (line 304) — replace hardcoded `gog gmail attachment` command with a backend-agnostic note or keep as-is with a comment that it will change in gmail-2.5\n\n## Acceptance Criteria\n\n- [ ] No `runGog()` or circuit breaker code remains in monitor.ts\n- [ ] `monitorGmail()` accepts `client: GmailClient` and threads it through all internal calls\n- [ ] `checkGogExists()` still works for startup health check\n- [ ] Client created in `startAccount()`, stored in `activeClients`, cleaned up on exit\n- [ ] `dispatchGmailMessage()` and `handleAction()` pass client to `sendGmailText()`\n- [ ] End-to-end: inbound polling, outbound replies, quoting, archiving, quarantine all work via client","status":"closed","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T23:30:00+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T19:59:20.660941479+13:00","closed_at":"2026-02-22T19:59:20.660941479+13:00","close_reason":"Closed","labels":["monitor","channel","refactor"],"dependencies":[{"issue_id":"gmail-2.1.3","depends_on_id":"gmail-2.1","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"gmail-2.1.3","depends_on_id":"gmail-2.1.2","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.2","title":"Implement OAuth2 flow and token management","description":"## Goal\n\nImplement the OAuth2 authorization flow and token storage needed for the API client. This bead adds the auth infrastructure without yet implementing any Gmail API calls.\n\n## Auth Flow\n\n### OAuth2 with google-auth-library (verified)\n\n`google-auth-library@10.5.0` is already in the dependency tree (transitive via `gaxios` from `@google/genai`). All methods below are verified against the library source and docs.\n\n```typescript\nimport { OAuth2Client } from 'google-auth-library';\n\nconst oauth2Client = new OAuth2Client(CLIENT_ID, CLIENT_SECRET, REDIRECT_URI);\n\n// Generate auth URL for browser consent\nconst authUrl = oauth2Client.generateAuthUrl({\n  access_type: 'offline',\n  scope: ['https://mail.google.com/'],\n  prompt: 'consent', // Force refresh_token generation\n});\n\n// Exchange authorization code for tokens\nconst { tokens } = await oauth2Client.getToken(authorizationCode);\n// tokens.refresh_token is what we store long-term\n// tokens.access_token auto-refreshes via the library\n```\n\nThe library emits a `'tokens'` event when tokens are refreshed, which can be used to persist updated access tokens if desired.\n\n### Credential Sources (in priority order)\n\n1. **OpenClaw config** — `channels.gmail.accounts.<email>.oauth.clientId`, `.clientSecret`, `.refreshToken`\n2. **gog credentials file** — Read `client_id`/`client_secret` from `~/.config/gogcli/credentials.json` (plain JSON, trivially parseable)\n3. **User prompt** — Ask for client_id/client_secret during onboarding if neither source exists\n\n### Implementation: `src/auth.ts`\n\n```typescript\nexport interface OAuthCredentials {\n  clientId: string;\n  clientSecret: string;\n  refreshToken: string;\n}\n\n// Resolve credentials from config or gog\nexport function resolveOAuthCredentials(\n  accountEmail: string,\n  cfg: OpenClawConfig\n): OAuthCredentials | null;\n\n// Read gog's credentials.json\nexport function readGogCredentials(): { clientId: string; clientSecret: string } | null;\n\n// Create authenticated OAuth2Client\nexport function createOAuth2Client(creds: OAuthCredentials): OAuth2Client;\n\n// Run browser-based OAuth flow, return refresh_token\nexport async function runOAuthFlow(\n  clientId: string,\n  clientSecret: string,\n  opts?: { port?: number }\n): Promise<string>;\n```\n\n### OAuth Flow Mechanics\n\nFor the browser OAuth flow, use a local HTTP server on a random port as the redirect URI:\n\n1. Start local HTTP server on `http://127.0.0.1:<port>`\n2. Open browser to Google consent URL with `redirect_uri=http://127.0.0.1:<port>/callback`\n3. User authorizes, Google redirects to localhost with `?code=...`\n4. Exchange code for tokens, extract refresh_token\n5. Shut down local server\n\n**IMPORTANT: Use `http://127.0.0.1` (loopback IP), NOT `http://localhost` (hostname).** Google's docs recommend the IP form for Desktop-type OAuth clients to avoid firewall issues. Loopback IPs are pre-allowed for Desktop OAuth clients — no explicit redirect URI registration needed in GCP console.\n\n### Token Storage\n\nStore the refresh_token in the OpenClaw config under:\n```json\n{\n  \"channels\": {\n    \"gmail\": {\n      \"accounts\": {\n        \"user@gmail.com\": {\n          \"oauth\": {\n            \"clientId\": \"...\",\n            \"clientSecret\": \"...\",\n            \"refreshToken\": \"...\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nUpdate Zod schema in `config.ts` to include `oauth` object on the account schema.\n\n### Current schema state (verified)\n\n**Zod schema** (config.ts:3-19): `GmailAccountSchema` — no `oauth` or `backend` fields yet. Both need adding here.\n\n**JSON schema** (channel.ts:173-203): mirrors Zod. Also needs `oauth` object and `backend` field.\n\n**Config access pattern**: readers use `cfg.channels?.gmail` (outbound.ts:49), writers use `sectionKey: \"openclaw-gmail\"` (channel.ts:225). Follow existing read pattern.\n\n### gog Credential Reuse\n\n`~/.config/gogcli/credentials.json` contains:\n```json\n{\n  \"client_id\": \"499832074112-....apps.googleusercontent.com\",\n  \"client_secret\": \"GOCSPX-...\"\n}\n```\n\nNo references to this path exist in the codebase currently — reading it is entirely new work.\n\nWe can read this to pre-fill client_id/client_secret, but still need our own refresh_token via a one-time re-auth. Since the user already consented to this OAuth client, Google may auto-approve without showing the consent screen again.\n\n**Do NOT attempt to extract tokens from gog's JWE keyring** (`~/.config/gogcli/keyring/`) — it uses PBES2-HS256+A128KW encryption with an OS-keychain-stored password. Too fragile and OS-dependent.\n\n## New Dependencies\n\n- `google-auth-library` — Already v10.5.0 in tree as transitive dep. Should be added as explicit dependency in package.json for stability.\n- Browser opening: Use `child_process` with `xdg-open` (Linux) / `open` (macOS) rather than adding the `open` npm package. Keeps deps minimal.\n\n## Files to create/modify\n\n- **Create** `src/auth.ts` — OAuth2 flow, credential resolution, gog cred reading\n- **Modify** `src/config.ts` — Add `oauth` object to `GmailAccountSchema`\n- **Modify** `src/channel.ts` — Add `oauth` object to JSON configSchema under account properties\n- **Modify** `src/gmail-client.ts` — Update factory to accept and pass OAuth2Client to future ApiGmailClient\n\n## Acceptance Criteria\n\n- [ ] `resolveOAuthCredentials()` reads from config, falls back to gog credentials.json for client_id/secret\n- [ ] `readGogCredentials()` parses `~/.config/gogcli/credentials.json`\n- [ ] `runOAuthFlow()` opens browser via `xdg-open`/`open`, receives callback on `http://127.0.0.1`, returns refresh_token\n- [ ] `createOAuth2Client()` creates authenticated client with auto-refresh\n- [ ] `oauth` schema added to account config (Zod + JSON schema)\n- [ ] Token refresh is automatic (handled by google-auth-library)\n- [ ] No Gmail API calls yet — this is auth infrastructure only","status":"closed","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T13:21:39.544879675+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T20:08:38.012382027+13:00","closed_at":"2026-02-22T20:08:38.012382027+13:00","close_reason":"Closed","labels":["auth","googleapis"],"dependencies":[{"issue_id":"gmail-2.2","depends_on_id":"gmail-2","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"gmail-2.2","depends_on_id":"gmail-2.1","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.2.1","title":"Add google-auth-library dep + config schema updates","description":"1. Add google-auth-library as explicit dep in package.json. 2. Add oauth object to GmailAccountSchema in config.ts. 3. Add oauth to JSON configSchema in channel.ts. 4. Surface backend + oauth fields in ResolvedGmailAccount in accounts.ts.","status":"closed","priority":2,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T20:05:02.892345338+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T20:06:17.031544469+13:00","closed_at":"2026-02-22T20:06:17.031544469+13:00","close_reason":"Closed","dependencies":[{"issue_id":"gmail-2.2.1","depends_on_id":"gmail-2.2","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.2.2","title":"Create src/auth.ts with OAuth2 infrastructure","description":"Implement: resolveOAuthCredentials(), readGogCredentials(), createOAuth2Client(), runOAuthFlow(). Local HTTP server for OAuth callback on 127.0.0.1, browser opening via xdg-open/open, credential resolution from config then gog fallback.","status":"closed","priority":2,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T20:05:08.780808733+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T20:07:15.800284601+13:00","closed_at":"2026-02-22T20:07:15.800284601+13:00","close_reason":"Closed","dependencies":[{"issue_id":"gmail-2.2.2","depends_on_id":"gmail-2.2","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"gmail-2.2.2","depends_on_id":"gmail-2.2.1","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.2.3","title":"Update factory + monitor for backend awareness","description":"1. Update createGmailClient() in gmail-client.ts to branch on account.backend - api returns stub/placeholder for now, gog returns GogGmailClient. 2. Make monitor.ts health check backend-aware (skip gog check for api backend).","status":"closed","priority":2,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T20:05:13.94842516+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T20:08:34.212481116+13:00","closed_at":"2026-02-22T20:08:34.212481116+13:00","close_reason":"Closed","dependencies":[{"issue_id":"gmail-2.2.3","depends_on_id":"gmail-2.2","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"gmail-2.2.3","depends_on_id":"gmail-2.2.2","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.3","title":"Implement ApiGmailClient read operations","description":"## Goal\n\nImplement the read-side Gmail API operations in `ApiGmailClient` using `@googleapis/gmail@16.1.1`. These are the operations that don't require MIME construction.\n\n## Operations to implement\n\n### Thread operations\n\n```typescript\n// getThread — replaces gog gmail thread get <id> --full --json\nasync getThread(threadId: string, opts?: { full?: boolean }): Promise<ThreadResponse | null> {\n  const res = await this.gmail.users.threads.get({\n    userId: 'me',\n    id: threadId,\n    format: opts?.full ? 'full' : 'metadata',\n  });\n  // Map res.data to ThreadResponse format (same shape as current gog output parsing)\n}\n```\n\n**Note:** `threads.get` supports `full`, `metadata`, `minimal` formats. The `raw` format is NOT available for threads (only individual messages). The `full` format returns complete message payloads including headers, parts, and body data — this matches what `gog gmail thread get --full` provides.\n\n### Message operations\n\n```typescript\n// getMessage — replaces gog gmail get <id>\nasync getMessage(messageId: string): Promise<GogRawMessage | null> {\n  const res = await this.gmail.users.messages.get({\n    userId: 'me',\n    id: messageId,\n    format: 'full',\n  });\n  // Map to existing GogRawMessage interface for compatibility\n}\n```\n\n### Search operations — IMPORTANT BEHAVIORAL DIFFERENCE\n\n**gog's `messages search --include-body`** returns rich `GogSearchMessage` objects with `from`, `subject`, `body` (decoded plain text), `labels[]` — everything needed for `parseSearchGmail()` in inbound.ts:115-158.\n\n**Gmail API's `messages.list`** only returns `{ id, threadId }[]` — NO body, NO headers. This is a fundamental difference.\n\n**Implementation strategy for `searchMessages()` with `includeBody: true`:**\n```typescript\nasync searchMessages(query: string, opts?: { maxResults?: number; includeBody?: boolean }): Promise<SearchResult[]> {\n  const res = await this.gmail.users.messages.list({\n    userId: 'me',\n    q: query,\n    maxResults: opts?.maxResults || 50,\n  });\n  const ids = res.data.messages || [];\n  \n  if (!opts?.includeBody || ids.length === 0) {\n    return ids.map(m => ({ id: m.id!, threadId: m.threadId! }));\n  }\n  \n  // Batch fetch message details to populate body/headers\n  // Use gmail.users.messages.get for each, or batch API\n  const results = await Promise.all(\n    ids.map(m => this.gmail.users.messages.get({\n      userId: 'me', id: m.id!, format: 'full',\n    }))\n  );\n  // Map to SearchResult with from/subject/body/labels\n}\n```\n\n**Performance note:** This is N+1 — one list call + N get calls. For 50 results, this may be slower than gog's single command. Consider using the Gmail batch API (`gmail.users.messages.batchGet` does NOT exist; use HTTP batching or accept N calls). Monitor.ts `performFullSync()` already does a follow-up `getMessage()` per result for attachment extraction (line 356), so the extra API calls may be tolerable.\n\nAlternative: refactor `performFullSync()` to use list + individual get calls, making `searchMessages` return only `{id, threadId}[]` always. This is the cleaner approach — current monitor.ts already does two passes (search then get for attachments).\n\n### Label operations\n\n```typescript\n// listLabels — replaces gog gmail labels list\nasync listLabels(): Promise<{ id: string; name: string }[]> {\n  const res = await this.gmail.users.labels.list({ userId: 'me' });\n  return (res.data.labels || []).map(l => ({ id: l.id!, name: l.name! }));\n}\n\n// createLabel — replaces gog gmail labels create\nasync createLabel(name: string): Promise<void> {\n  await this.gmail.users.labels.create({\n    userId: 'me',\n    requestBody: { name },\n  });\n}\n```\n\n### Attachment operations\n\n```typescript\n// downloadAttachment — replaces gog gmail attachment <messageId> <attachmentId> --out <path>\n// API returns base64url data; we write to disk to match gog behavior\nasync downloadAttachment(messageId: string, attachmentId: string, outPath: string): Promise<void> {\n  const res = await this.gmail.users.messages.attachments.get({\n    userId: 'me',\n    messageId,\n    id: attachmentId,\n  });\n  const buf = Buffer.from(res.data.data!, 'base64url');\n  await fs.writeFile(outPath, buf);\n}\n```\n\n### Settings operations\n\n```typescript\n// getSendAs — replaces gog gmail settings sendas list\nasync getSendAs(): Promise<{ displayName?: string; email: string; isPrimary?: boolean }[]> {\n  const res = await this.gmail.users.settings.sendAs.list({ userId: 'me' });\n  return (res.data.sendAs || []).map(s => ({\n    displayName: s.displayName || undefined,\n    email: s.sendAsEmail!,\n    isPrimary: s.isPrimary || false,\n  }));\n}\n```\n\n## Response mapping\n\nThe `@googleapis/gmail` returns typed `gmail_v1.Schema$Message` responses that map closely to the codebase's internal types:\n\n| API field | Internal type field | Notes |\n|-----------|-------------------|-------|\n| `payload.headers[]` | `GogRawMessage.payload.headers[]` | Same `{name, value}` shape |\n| `payload.parts[]` | `GogRawMessage.payload.parts[]` | Same `{mimeType, body.data}` shape |\n| `payload.body.data` | `GogRawMessage.payload.body.data` | Both base64-encoded strings |\n| `labelIds[]` | `GogRawMessage.labelIds[]` | Identical |\n| `internalDate` | `GogRawMessage.internalDate` | API returns string (ms since epoch), same as gog |\n| `id`, `threadId` | Same | Identical |\n\nPrefer adapting the API response to match the existing `GogRawMessage` shape rather than changing all consumers. This keeps the diff small and avoids touching quoting.ts/outbound-check.ts beyond the client swap.\n\n**Key consumer types and their locations:**\n- `GogRawMessage` (quoting.ts:39-49) — used by `parseGogMessage()` at quoting.ts:97-114\n- `GogPayload` (inbound.ts:6-25) — used by `parseInboundGmail()` at inbound.ts:27-95\n- `GogSearchMessage` (inbound.ts:105-113) — used by `parseSearchGmail()` at inbound.ts:115-158\n- `ThreadResponse` (quoting.ts:23-27) — returned by `fetchThread()`, consumed by `buildQuotedThread()`\n\n## New Dependencies\n\n- `@googleapis/gmail@^16.1.1` — Standalone Gmail API client (~1.15 MB unpacked, 88 transitive packages shared with existing google-auth-library)\n\n## Files to create/modify\n\n- **Create** `src/api-client.ts` — `ApiGmailClient` class implementing `GmailClient` interface (read ops)\n- **Modify** `src/gmail-client.ts` — Update factory to return `ApiGmailClient` when `backend: \"api\"` and valid OAuth credentials (from gmail-2.2's `resolveOAuthCredentials()`)\n- **Modify** `package.json` — Add `@googleapis/gmail` dependency\n\n## Acceptance Criteria\n\n- [ ] `ApiGmailClient` implements all read methods from `GmailClient` interface\n- [ ] Response shapes match existing `GogRawMessage` / `ThreadResponse` interfaces\n- [ ] `searchMessages()` with `includeBody: true` fetches full message details (N+1 or batch)\n- [ ] `downloadAttachment()` writes to disk (not just returns Buffer)\n- [ ] Factory returns `ApiGmailClient` when account has `backend: \"api\"` and valid OAuth credentials\n- [ ] Error handling: typed exceptions from googleapis, no stderr parsing\n- [ ] All read operations tested against a real Gmail account (manual test)","status":"closed","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T13:22:00.145344761+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T20:13:02.578614612+13:00","closed_at":"2026-02-22T20:13:02.578614612+13:00","close_reason":"Closed","labels":["googleapis","api-client"],"dependencies":[{"issue_id":"gmail-2.3","depends_on_id":"gmail-2","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"gmail-2.3","depends_on_id":"gmail-2.1","type":"blocks","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"gmail-2.3","depends_on_id":"gmail-2.2","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.3.1","title":"Implement ApiGmailClient read operations","description":"Create src/api-client.ts with all read methods: getThread, getMessage, searchMessages, searchThreads, modifyLabels, modifyThreadLabels, listLabels, createLabel, downloadAttachment, getSendAs. Map API responses to existing GogRawMessage/ThreadResponse shapes. send() throws NotImplemented (gmail-2.4 scope).","status":"closed","priority":2,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T20:10:58.20407875+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T20:12:18.112869873+13:00","closed_at":"2026-02-22T20:12:18.112869873+13:00","close_reason":"Closed","dependencies":[{"issue_id":"gmail-2.3.1","depends_on_id":"gmail-2.3","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.3.2","title":"Wire ApiGmailClient into factory","description":"Update gmail-client.ts to import and return ApiGmailClient when backend=api with valid OAuth credentials. Remove the placeholder throw.","status":"closed","priority":2,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T20:11:03.257594326+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T20:13:02.541153742+13:00","closed_at":"2026-02-22T20:13:02.541153742+13:00","close_reason":"Closed","dependencies":[{"issue_id":"gmail-2.3.2","depends_on_id":"gmail-2.3","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"gmail-2.3.2","depends_on_id":"gmail-2.3.1","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.4","title":"Implement ApiGmailClient write operations and MIME construction","description":"## Goal\n\nImplement the write-side Gmail API operations: send, reply, reply-all (requiring MIME construction), and label modification.\n\n## MIME Construction with MailComposer (verified)\n\n`gmail.users.messages.send` requires a base64url-encoded RFC 2822 MIME message. Use nodemailer's MailComposer.\n\n**Verified:** `nodemailer/lib/mail-composer` supports `from`, `to`, `cc`, `subject`, `text`, `html`, `inReplyTo`, `references`. `compile().build()` produces a valid RFC 2822/5322 formatted Buffer. The Gmail API accepts this output when base64url-encoded.\n\n```typescript\nimport MailComposer from 'nodemailer/lib/mail-composer';\n\nasync function buildMimeMessage(opts: {\n  from: string;\n  to: string;\n  cc?: string;\n  subject: string;\n  text: string;\n  html: string;\n  inReplyTo?: string;\n  references?: string;\n}): Promise<Buffer> {\n  const mail = new MailComposer({\n    from: opts.from,\n    to: opts.to,\n    cc: opts.cc,\n    subject: opts.subject,\n    text: opts.text,\n    html: opts.html,\n    inReplyTo: opts.inReplyTo,\n    references: opts.references,\n  });\n\n  return new Promise((resolve, reject) => {\n    mail.compile().build((err, message) => {\n      if (err) reject(err);\n      else resolve(message);\n    });\n  });\n}\n```\n\n## Operations to implement\n\n### Send (new email and reply)\n\n```typescript\nasync send(opts: {\n  from: string;\n  to: string;\n  cc?: string;\n  subject: string;\n  textBody: string;\n  htmlBody: string;\n  threadId?: string;\n  inReplyTo?: string;\n  references?: string;\n  replyAll?: boolean;\n}): Promise<{ messageId: string }> {\n  const mime = await buildMimeMessage({\n    from: opts.from,\n    to: opts.to,\n    cc: opts.cc,\n    subject: opts.subject,\n    text: opts.textBody,\n    html: opts.htmlBody,\n    inReplyTo: opts.inReplyTo,\n    references: opts.references,\n  });\n\n  const res = await this.gmail.users.messages.send({\n    userId: 'me',\n    requestBody: {\n      raw: mime.toString('base64url'),\n      threadId: opts.threadId,\n    },\n  });\n\n  return { messageId: res.data.id! };\n}\n```\n\n**Note on `replyAll` flag:** For `GogGmailClient`, `replyAll` is passed as `--reply-all` to gog which handles recipient resolution internally. For `ApiGmailClient`, `replyAll` is a no-op on `send()` — the caller must resolve To/Cc explicitly via `resolveReplyRecipients()` before calling `send()`. The flag exists on the interface for GogGmailClient backward compat.\n\n### Reply-All recipient resolution\n\nFor reply-all, the caller (outbound.ts) needs to determine To and Cc from the thread. This logic currently exists implicitly via gog's `--reply-all` flag. With the API client, we need to extract recipients explicitly.\n\n**Existing code to reuse:** `outbound-check.ts:64-84` already extracts participants from thread headers via `parseEmailAddresses()` (line 113-141). This handles formats like `email@domain`, `Name <email>`, `\"Last, First\" <email>`. The `resolveReplyRecipients()` function can leverage this existing parser.\n\nRecipient resolution logic:\n1. Get the last message in the thread (via `getThread`)\n2. Extract From, To, Cc headers using existing `parseEmailAddresses()`\n3. Set `To:` = original sender (From of the message being replied to)\n4. Set `Cc:` = everyone from original To + Cc, minus self\n5. Extract `Message-ID` header for `In-Reply-To` and `References`\n\n```typescript\nexport interface ReplyRecipients {\n  to: string;\n  cc?: string;\n  inReplyTo: string;\n  references: string;\n  subject: string;\n}\n\nasync resolveReplyRecipients(threadId: string, selfEmail: string): Promise<ReplyRecipients | null>;\n```\n\nThis replaces the need for gog's `--reply-all` and `--reply-to-message-id` flags.\n\n### Label modification\n\n```typescript\nasync modifyLabels(messageId: string, opts: { add?: string[]; remove?: string[] }): Promise<void> {\n  await this.gmail.users.messages.modify({\n    userId: 'me',\n    id: messageId,\n    requestBody: {\n      addLabelIds: opts.add,\n      removeLabelIds: opts.remove,\n    },\n  });\n}\n\nasync modifyThreadLabels(threadId: string, opts: { add?: string[]; remove?: string[] }): Promise<void> {\n  await this.gmail.users.threads.modify({\n    userId: 'me',\n    id: threadId,\n    requestBody: {\n      addLabelIds: opts.add,\n      removeLabelIds: opts.remove,\n    },\n  });\n}\n```\n\n## Current outbound flow (verified, outbound.ts:46-191)\n\nThe current `sendGmailText()` flow that needs updating:\n1. Target resolution: threadId vs email address (line 47-57)\n2. GOG args construction with `--to`, `--subject`, `--thread-id` / `--reply-to-message-id`, `--reply-all` (line 59-123)\n3. Recipient validation via `validateThreadReply()` (line 84-108)\n4. Quote fetch via `fetchQuotedContext()` (line 124-136)\n5. Markdown → HTML via `marked.parse()` + `sanitize-html` (line 139-171)\n6. Append Gmail-style blockquote HTML for quotes (line 154-158)\n7. Execute `spawnGog([\"gmail\", \"send\", ...args])` (line 173)\n8. Archive on reply: `spawnGog([\"gmail\", \"labels\", \"modify\", ...])` (line 175-188)\n\nFor `ApiGmailClient`, steps 2 and 7 change: instead of building gog CLI args, call `resolveReplyRecipients()` then `send()`. Steps 3-6 and 8 remain the same (they're in outbound.ts, not the client). The outbound.ts flow will need conditional logic or the client abstraction handles the difference.\n\n## New Dependencies\n\n- `nodemailer` — For MailComposer (MIME construction only, not SMTP transport)\n- `@types/nodemailer` — TypeScript types (dev dependency)\n\n## Key differences from gog\n\n| gog flag | API equivalent |\n|----------|---------------|\n| `--reply-all` | Manually set To/Cc from thread headers via `resolveReplyRecipients()` |\n| `--reply-to-message-id <id>` | Set `threadId` + `In-Reply-To`/`References` MIME headers |\n| `--body-html <html>` | Pass `html` to MailComposer |\n| `--body <text>` | Pass `text` to MailComposer (produces `multipart/alternative`) |\n| `--subject <subj>` | Pass `subject` to MailComposer |\n| `--account <email>` | OAuth2Client scoped to account |\n\n## Files to modify\n\n- **Modify** `src/api-client.ts` — Add `send()`, `modifyLabels()`, `modifyThreadLabels()`, `resolveReplyRecipients()`\n- **Create** `src/mime.ts` — `buildMimeMessage()` helper wrapping MailComposer\n- **Modify** `src/outbound.ts` — Update `sendGmailText()` to use `client.send()` + `client.resolveReplyRecipients()` instead of building gog args. The markdown/HTML conversion and quote handling stay in outbound.ts.\n- **Modify** `package.json` — Add `nodemailer` dependency, add `@types/nodemailer` dev dependency\n\n## Acceptance Criteria\n\n- [ ] `send()` constructs valid RFC 2822 MIME via MailComposer and sends via API\n- [ ] Reply threading works: `threadId`, `In-Reply-To`, `References` headers correctly set\n- [ ] Reply-all correctly determines To/Cc from thread (excludes self from Cc)\n- [ ] Reuses existing `parseEmailAddresses()` from outbound-check.ts for header parsing\n- [ ] `modifyLabels()` and `modifyThreadLabels()` work for archive (remove INBOX), mark read (remove UNREAD)\n- [ ] HTML and plain text bodies both included in multipart/alternative MIME\n- [ ] Manual test: send a reply via API client, verify it threads correctly in Gmail\n- [ ] Manual test: reply-all sends to all participants","status":"open","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T13:22:26.966169288+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T23:00:00+13:00","labels":["googleapis","api-client","mime"],"dependencies":[{"issue_id":"gmail-2.4","depends_on_id":"gmail-2","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"gmail-2.4","depends_on_id":"gmail-2.3","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-2.5","title":"Overhaul onboarding for googleapis and gog credential reuse","description":"## Goal\n\nUpdate the onboarding flow to support both new users (no gog) and existing gog users migrating to the API backend. The current onboarding in `src/onboarding.ts` is entirely gog-dependent (checks gog version, runs gog auth, etc.).\n\n## Current onboarding flow (verified, onboarding.ts:72-214)\n\nThe `gmailOnboardingAdapter.configure()` method uses OpenClaw's `prompter` interface (`text()`, `confirm()`, `note()`) for all user interaction.\n\n### Current steps:\n1. `checkGogInstalled()` (line 100-106) — **HARD GATE**, throws if gog missing\n2. `getGogVersion()` (line 108-114) — warns if below v1.2.0 (`MIN_GOG_VERSION` at line 10)\n3. `promptAccountId()` from OpenClaw SDK if reconfiguring existing account (line 122-129)\n4. `prompter.text()` for email address (line 134-138)\n5. `checkGogAuth(email)` — checks `gog auth list --plain` (line 41-48)\n6. `authorizeGog(email)` — spawns `gog auth add <email>` with `stdio: \"inherit\"` (line 50-59)\n7. `prompter.text()` for `allowFrom` — comma-separated emails (line 159-163)\n8. `prompter.text()` for `pollIntervalMs` — seconds, converted to ms (line 165-173)\n9. `fetchGmailName(email)` — `gog gmail settings sendas list --account <email> --json` (line 61-70, 175)\n10. Config write with `sectionKey` and account merge (line 188-203)\n\n### Helper functions (line 12-70):\n- `checkGogInstalled()`: `command -v gog` via exec\n- `getGogVersion()`: `gog --version` with regex parse\n- `checkGogAuth(email)`: `gog auth list --plain`, checks stdout for email\n- `authorizeGog(email)`: spawns `gog auth add <email>` interactively\n- `fetchGmailName(email)`: `gog gmail settings sendas list --account <email> --json`, returns displayName\n\n## Onboarding Scenarios\n\n### Scenario A: Existing gog user\n\n1. Detect gog is installed and authorized for this email (`gog auth list --plain`)\n2. Detect `~/.config/gogcli/credentials.json` exists — read client_id/client_secret via `readGogCredentials()` from auth.ts\n3. Prompt: \"We found your gog credentials. Migrate to direct API access? (one-time browser auth)\" \n4. If yes: run OAuth flow with gog's client_id/secret → store refresh_token in config, set `backend: \"api\"`\n5. If no: keep `backend: \"gog\"`, existing flow unchanged\n6. Continue with allowFrom, polling interval, display name (fetch via `client.getSendAs()` if migrated, gog if not)\n\n### Scenario B: New user, no gog\n\n1. Detect gog is NOT installed\n2. Prompt for GCP OAuth client_id and client_secret (guide user to console.cloud.google.com)\n3. Prompt for email address\n4. Run OAuth flow → store credentials and refresh_token in config, set `backend: \"api\"`\n5. Continue with allowFrom, polling interval, display name (fetch via `client.getSendAs()`)\n\n### Scenario C: New user, has gog but wants API\n\nSame as Scenario A — gog detected, offer migration.\n\n### Scenario D: Existing API user reconfiguring\n\n1. Detect existing OAuth credentials in config via `resolveOAuthCredentials()` from auth.ts\n2. Skip auth flow, just update other settings\n3. Offer to re-authorize if token is expired/invalid\n\n## New flow\n\n1. Check for existing OAuth credentials in config\n2. If none: check for gog credentials file → check for gog installed\n3. Based on what's available, choose auth path (API OAuth vs gog)\n4. Prompt email (via `prompter.text()`)\n5. Run appropriate auth flow\n6. Prompt allowFrom, polling (via `prompter.text()`)\n7. Fetch display name (via `client.getSendAs()` for API backend, `fetchGmailName()` for gog backend)\n8. Write config with `backend: \"api\"` or `\"gog\"`\n\n**Critical**: gog is no longer a hard requirement. The `checkGogInstalled()` gate at line 100 must become conditional — only required when `backend: \"gog\"`.\n\n## Onboarding UX for GCP setup (new users without gog)\n\nNew users need to create a GCP OAuth client. Guide text (via `prompter.note()`):\n\n```\nTo use Gmail with OpenClaw, you need a Google Cloud OAuth client:\n1. Go to https://console.cloud.google.com/apis/credentials\n2. Create a project (or use existing)\n3. Enable the Gmail API\n4. Create OAuth 2.0 Client ID (type: Desktop app)\n5. Copy the Client ID and Client Secret\n```\n\nThis is the same setup gog requires, so the friction is equivalent.\n\n## Files to modify\n\n- **Modify** `src/onboarding.ts` — Conditional gog checks, API auth path, gog cred reuse. Keep using `prompter` interface for all user interaction.\n- **Modify** `src/auth.ts` (from gmail-2.2) — May need helpers for credential validation\n\n## Acceptance Criteria\n\n- [ ] New user without gog can complete onboarding via OAuth (no gog dependency)\n- [ ] Existing gog user offered seamless migration with one-time browser re-auth\n- [ ] Existing gog user can decline migration and keep using gog backend\n- [ ] Client_id/client_secret read from gog's credentials.json via `readGogCredentials()` when available\n- [ ] Display name fetched via `client.getSendAs()` when using api backend, via gog when using gog backend\n- [ ] Config written with correct `backend` value\n- [ ] `gog` is no longer a hard requirement for the extension\n- [ ] All user prompts use OpenClaw's `prompter` interface (text/confirm/note)","status":"open","priority":1,"issue_type":"task","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T13:22:55.796782095+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T23:00:00+13:00","labels":["onboarding","auth","googleapis"],"dependencies":[{"issue_id":"gmail-2.5","depends_on_id":"gmail-2","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"gmail-2.5","depends_on_id":"gmail-2.2","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"gmail-3","title":"Fix channel ID mismatch preventing async outbound delivery","description":"## Problem\n\nThe plugin tags all inbound messages with \\`OriginatingChannel: \"gmail\"\\` (set in \\`src/channel.ts\\` buildGmailMsgContext and \\`src/inbound.ts\\`), so OpenClaw sessions record \\`lastChannel: \"gmail\"\\`. However, the plugin registers itself with ID \\`\"openclaw-gmail\"\\`.\n\nWhen the gateway attempts async outbound delivery (e.g. subagent completion announces), it calls \\`loadChannelOutboundAdapter(\"gmail\")\\` — which looks up plugins by their registered ID. Since no plugin is registered as \\`\"gmail\"\\`, this returns undefined and delivery **silently fails**, falling back to stale routes from other channels.\n\n## Root Cause\n\n\\`src/channel.ts\\` line 160: plugin registers as \\`id: \"openclaw-gmail\"\\`\n\\`src/channel.ts\\` line 74: inbound messages tagged \\`Provider: \"gmail\"\\`, \\`Surface: \"gmail\"\\`, \\`OriginatingChannel: \"gmail\"\\`\n\nThe gateway's \\`loadChannelOutboundAdapter()\\` resolves by registered plugin ID, not by the surface/provider strings. Sessions with \\`lastChannel: \"gmail\"\\` can't route back to \\`\"openclaw-gmail\"\\`.\n\n## Fix\n\nAdd \\`\"gmail\"\\` as an alias in the plugin's channel meta so \\`normalizeMessageChannel(\"gmail\")\\` resolves to \\`\"openclaw-gmail\"\\`:\n\nIn \\`src/channel.ts\\`, update the meta object in the \\`gmailPlugin\\` export:\n\n```typescript\nmeta: {\n  ...meta,\n  id: \"openclaw-gmail\",\n  aliases: [\"gmail\"],\n  showConfigured: true,\n},\n```\n\nThis is a plugin-side-only fix — no OpenClaw core changes needed. The \\`aliases\\` field is supported by the plugin SDK's channel resolution.\n\n## Impact\n\nWithout this fix:\n- Subagent completion results that should be delivered via Gmail are silently lost\n- Any async outbound delivery (scheduled messages, webhook-triggered replies) fails for Gmail sessions\n- Users see their agent \"not responding\" for async workflows even though the agent completed successfully\n\n## Files to modify\n\n- \\`src/channel.ts\\` — Add \\`aliases: [\"gmail\"]\\` to plugin meta\n\n## Testing\n\n1. Start a Gmail session, trigger a subagent (e.g. tool use that runs async)\n2. Verify the subagent result is delivered back to the Gmail thread\n3. Verify synchronous replies (direct inbound → dispatch → deliver) still work\n\n## Acceptance Criteria\n\n- [ ] \\`aliases: [\"gmail\"]\\` added to plugin meta in \\`channel.ts\\`\n- [ ] \\`loadChannelOutboundAdapter(\"gmail\")\\` resolves to the openclaw-gmail plugin\n- [ ] Async outbound delivery works for Gmail sessions\n- [ ] No change to synchronous reply behavior","status":"closed","priority":0,"issue_type":"bug","owner":"mcinteerj@gmail.com","created_at":"2026-02-22T13:23:17.073349097+13:00","created_by":"Jake McInteer","updated_at":"2026-02-22T13:26:59.923821758+13:00","closed_at":"2026-02-22T13:26:59.923821758+13:00","close_reason":"Fixed: added aliases: [\"gmail\"] to plugin meta","labels":["outbound","channel-id","P0"]}
